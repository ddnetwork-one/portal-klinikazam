<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal - Klinik Pergigian Azam</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK (Added Auth) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- VARIABLES --- */
        :root {
            --primary: #0284c7;
            --primary-dark: #0369a1;
            --primary-light: #e0f2fe;
            --secondary: #14b8a6;
            --success: #10b981;
            --success-bg: #dcfce7;
            --warning: #f59e0b;
            --warning-bg: #fef3c7;
            --danger: #ef4444;
            --danger-bg: #fee2e2;
            --info: #3b82f6;
            --info-bg: #dbeafe;
            --wa-color: #25D366;
            --wa-bg: #dcfce7;
            
            --bg-body: #f8fafc;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            
            --text-main: #0f172a;
            --text-light: #64748b;
            --border-light: #e2e8f0;
            
            --sidebar-width: 280px;
            --header-height: 70px;
            --radius: 12px;
            --radius-lg: 16px;
            
            --shadow-sm: 0 2px 4px -1px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 12px 24px -5px rgba(2, 132, 199, 0.15);
            
            --transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* --- BASE RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }
        
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; font-weight: 700; color: var(--text-main); letter-spacing: -0.01em; }
        button { cursor: pointer; border: none; font-family: inherit; transition: var(--transition); }
        input, select, textarea { font-family: inherit; }

        /* --- LOADING OVERLAY --- */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 10; display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
            border-radius: var(--radius);
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .loading-overlay.active { opacity: 1; pointer-events: auto; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(2, 132, 199, 0.1); border-left-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- COMPONENTS --- */
        .invoice-link { color: var(--primary); text-decoration: underline; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .invoice-link:hover { opacity: 0.8; }

        /* --- SEARCH INPUT --- */
        .search-container { position: relative; width: 100%; max-width: 300px; }
        .search-input { width: 100%; padding: 10px 10px 10px 36px; border: 1px solid var(--border-light); border-radius: var(--radius); font-size: 0.85rem; background: #f8fafc; transition: var(--transition); color: var(--text-main); }
        .search-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-light); font-size: 0.85rem; }

        /* --- CUSTOM PATIENT SEARCH COMPONENT --- */
        .custom-select-wrapper { position: relative; width: 100%; }
        .custom-select-header { position: relative; }
        .custom-select-input {
            width: 100%;
            padding: 14px 36px 14px 16px;
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: var(--transition);
            color: var(--text-main);
            cursor: text;
        }
        .custom-select-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.1); }
        .clear-selection {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            color: var(--text-light); cursor: pointer; font-size: 1rem;
            display: none; z-index: 2;
        }
        .clear-selection:hover { color: var(--danger); }
        .options-list {
            position: absolute; top: 100%; left: 0; right: 0; background: white;
            border: 1px solid var(--border-light); border-radius: var(--radius);
            box-shadow: var(--shadow-lg); max-height: 250px; overflow-y: auto;
            z-index: 100; margin-top: 5px; display: none; list-style: none;
        }
        .options-list.show { display: block; }
        .options-list li {
            padding: 12px 16px; font-size: 0.9rem; color: var(--text-main);
            cursor: pointer; border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .options-list li:hover { background-color: var(--primary-light); color: var(--primary-dark); }
        .options-list li .sub-text { display: block; font-size: 0.75rem; color: var(--text-light); margin-top: 2px; }
        .no-option { padding: 12px; text-align: center; color: var(--text-light); font-style: italic; font-size: 0.85rem; background: #f8fafc; }

        /* --- LOGIN --- */
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; transition: opacity 0.5s; }
        #login-screen.hidden { opacity: 0; pointer-events: none; }
        .login-card { background: rgba(255,255,255, 0.95); backdrop-filter: blur(20px); padding: 40px; border-radius: 24px; width: 100%; max-width: 420px; box-shadow: var(--shadow-lg); text-align: center; animation: floatUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); border:1px solid rgba(255,255,255,0.8); }
        @keyframes floatUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .logo-img { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow-sm); }
        .logo-large { width: 80px; height: 80px; object-fit: cover; border-radius: 20px; border: 4px solid white; box-shadow: var(--shadow-md); margin-bottom: 1rem; }
        
        .form-input { width: 100%; padding: 14px 16px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: var(--radius); font-size: 0.95rem; transition: var(--transition); color: var(--text-main); }
        .form-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.1); }
        
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; font-weight: 600; font-size: 1rem; border-radius: var(--radius); box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3); display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(2, 132, 199, 0.4); }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; transform: none; }

        /* --- SIDEBAR --- */
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border-light); display: flex; flex-direction: column; position: relative; z-index: 50; transition: transform 0.3s ease; }
        .brand { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; font-size: 1.1rem; font-weight: 800; color: var(--primary-dark); border-bottom: 1px solid #f1f5f9; }
        .nav-menu { flex: 1; padding: 20px 16px; list-style: none; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; padding: 12px 16px; margin-bottom: 4px; color: var(--text-light); font-weight: 500; border-radius: var(--radius); cursor: pointer; transition: var(--transition); font-size: 0.9rem; white-space: nowrap; }
        .nav-item i { width: 26px; font-size: 1.1rem; margin-right: 12px; text-align: center; color: var(--primary); transition: color 0.2s; }
        .nav-item:hover { background: #f0f9ff; color: var(--primary-dark); }
        .nav-item:hover i { color: var(--primary-dark); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; border-left: 4px solid var(--primary); border-radius: 0 12px 12px 0; padding-left: 12px; }
        .sidebar-footer { padding: 16px; border-top: 1px solid #f1f5f9; }
        .user-pill { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 12px; background: #f8fafc; cursor: pointer; border: 1px solid transparent; transition: var(--transition); }
        .user-pill:hover { border-color: var(--border-light); background: white; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; flex-shrink: 0; }

        /* --- MAIN WRAPPER --- */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; width: 100%; }
        
        /* --- HEADER --- */
        header { height: var(--header-height); background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-light); display: grid; grid-template-columns: auto 1fr auto; align-items: center; padding: 0 20px; position: sticky; top: 0; z-index: 40; width: 100%; }
        
        .mobile-menu-btn { display: none; background: none; font-size: 1.2rem; color: var(--text-main); padding: 8px; border-radius: 8px; transition: background 0.2s; }
        .mobile-menu-btn:hover { background: #f1f5f9; }

        .header-title { display: flex; flex-direction: column; justify-content: center; }
        .header-title h2 { font-size: 1.1rem; line-height: 1.2; }
        .header-title p { font-size: 0.75rem; color: var(--text-light); display: none; }

        .header-center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .live-clock-container { display: flex; align-items: center; gap: 10px; background: white; padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border-light); box-shadow: var(--shadow-sm); }
        .live-time { font-family: 'Poppins', sans-serif; font-variant-numeric: tabular-nums; font-weight: 800; font-size: 1.1rem; color: var(--primary); line-height: 1; }
        .live-date-header { font-size: 0.75rem; color: var(--text-light); font-weight: 600; margin-top: 2px; }

        .header-right { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }

        /* --- CONTENT AREA --- */
        .content-area { flex: 1; padding: 24px; overflow-y: auto; overflow-x: hidden; position: relative; }

        /* --- CARDS & TABLES --- */
        .section-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); padding: 24px; margin-bottom: 24px; animation: fadeIn 0.4s ease; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* UPDATED: SuperAdmin Card Styling */
        .section-card.super-admin-card {
            border-left: 5px solid var(--danger); /* Red Border */
            background-color: var(--danger-bg); /* Light Red Background */
            border-top: 1px solid var(--danger);
            border-right: 1px solid var(--danger);
            border-bottom: 1px solid var(--danger);
        }

        .table-header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .table-header-actions { display: flex; justify-content: space-between; align-items: center; gap: 10px; width: 100%; flex-wrap: wrap; }
        .table-header h3 { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }

        /* Sort Dropdown Styling */
        .sort-select {
            padding: 8px 12px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-main);
            background: white;
            cursor: pointer;
        }
        .sort-select:focus { border-color: var(--primary); }

        .table-responsive { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border-light); width: 100%; -webkit-overflow-scrolling: touch; background: white; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 600px; }
        th { text-align: left; padding: 14px 16px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-light); background: #f8fafc; font-weight: 700; white-space: nowrap; border-bottom: 1px solid var(--border-light); }
        td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: var(--text-main); vertical-align: middle; white-space: nowrap; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fcfcfc; }

        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; display: inline-block; letter-spacing: 0.03em; }
        .badge-pending { background: var(--warning-bg); color: #b45309; }
        .badge-confirmed { background: var(--info-bg); color: #1d4ed8; }
        .badge-completed { background: var(--success-bg); color: #15803d; }
        .badge-cancelled { background: var(--danger-bg); color: #b91c1c; }
        .badge-info { background: var(--info-bg); color: #1e40af; }

        .btn-sm { padding: 8px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; border: 1px solid var(--border-light); background: white; color: var(--text-main); display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; transition: var(--transition); }
        .btn-sm:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-1px); }
        .btn-sm:active { transform: translateY(0); }
        .btn-bill { background: var(--primary); color: white; border: none; }
        .btn-bill:hover { background: var(--primary-dark); }
        .btn-delete { color: var(--danger); border-color: #fee2e2; background: #fff; }
        .btn-delete:hover { background: var(--danger-bg); }
        .btn-wa { color: var(--wa-color); border-color: #dcfce7; background: #fff; }
        .btn-wa:hover { background: var(--wa-bg); }
        .btn-reset { color: var(--warning); border-color: #fef3c7; background: #fff; }
        .btn-reset:hover { background: var(--warning-bg); }

        /* --- PAGINATION --- */
        .pagination-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-light);
            gap: 10px; flex-wrap: wrap;
        }
        .pagination-info { font-size: 0.85rem; color: var(--text-light); font-weight: 500; }
        .pagination-controls { display: flex; align-items: center; gap: 8px; }
        .pagination-btn {
            background: white; border: 1px solid var(--border-light);
            padding: 6px 12px; border-radius: 6px; font-size: 0.85rem;
            cursor: pointer; color: var(--text-main); transition: var(--transition);
            display: flex; align-items: center; justify-content: center;
        }
        .pagination-btn:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #f1f5f9; }
        .rows-per-page-select {
            padding: 6px; border-radius: 6px; border: 1px solid var(--border-light);
            font-size: 0.85rem; color: var(--text-main); background: white;
            margin-right: 10px;
        }

        /* --- DASHBOARD STATS --- */
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { display: flex; justify-content: space-between; align-items: center; padding: 24px; position: relative; overflow: hidden; }
        .stat-card::before { content:''; position: absolute; top:0; left:0; width:4px; height:100%; background: var(--primary); opacity: 0.5; }
        .stat-card h3 { font-size: 2rem; margin-bottom: 5px; color: var(--text-main); }
        .stat-card p { font-size: 0.85rem; color: var(--text-light); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; opacity: 0.9; }

        /* --- INVOICE LAYOUT (UPDATED) --- */
        .invoice-box {
            max-width: 850px;
            margin: auto;
            background: white;
            font-family: 'Inter', "Segoe UI", Arial, sans-serif;
            color: #1f2937;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        .invoice-top-bar {
            height: 6px;
            background: var(--primary);
        }

        .invoice-content {
            padding: 30px;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .invoice-brand h2 { margin: 0; font-size: 22px; letter-spacing: 0.5px; color: var(--primary); }
        .invoice-brand p { margin: 3px 0; color: #6b7280; font-size: 11px; }
        
        .invoice-title-group { text-align: right; }
        .invoice-title-group h1 { margin: 0; font-size: 28px; letter-spacing: 2px; }
        .invoice-title-group span { color: #6b7280; font-size: 11px; display: block; margin-top: 4px; }

        .invoice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .invoice-box h4 {
            margin: 0 0 8px;
            font-size: 11px;
            letter-spacing: 1px;
            color: var(--primary);
            text-transform: uppercase;
        }
        
        .invoice-box p {
            margin: 2px 0;
            color: #1f2937;
            font-size: 12px;
        }

        .item-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        .item-table th {
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 1px;
            color: #6b7280;
            text-align: left;
            padding: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        .item-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 12px;
            vertical-align: top;
        }
        
        .invoice-summary { display: flex; justify-content: flex-end; }
        .invoice-summary-box {
            width: 320px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            background: #f9fafb;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .summary-row.total {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid var(--primary);
            font-size: 16px;
            font-weight: 600;
        }
        
        .right { text-align: right; }
        .text-right { text-align: right; }

        .invoice-footer {
            margin-top: 40px;
            border-top: 1px solid #e5e7eb;
            padding-top: 15px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #6b7280;
        }

        /* --- CASH BILL PAGE --- */
        .bill-container { display: grid; grid-template-columns: 1fr 350px; gap: 24px; }
        .bill-actions-area { display: flex; flex-direction: column; gap: 15px; }
        .payment-type-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .pay-type { padding: 15px; border: 2px solid var(--border-light); border-radius: var(--radius); text-align: center; cursor: pointer; transition: var(--transition); background: white; }
        .pay-type:hover { border-color: var(--primary-light); }
        .pay-type.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary-dark); font-weight: 700; }
        .pay-type i { font-size: 1.5rem; display: block; margin-bottom: 5px; }

        /* --- BOOKING --- */
        .booking-container { display: grid; gap: 20px; height: auto; grid-template-columns: 300px 280px 1fr; }
        .booking-panel { background: white; border: 1px solid var(--border-light); border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; height: 100%; max-height: 700px; box-shadow: var(--shadow-sm); }
        .calendar-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .calendar-header button { background: white; border: 1px solid #e2e8f0; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-light); transition: 0.2s; cursor: pointer; }
        .calendar-header button:hover { color: var(--primary); border-color: var(--primary); }
        .month-label { font-weight: 700; font-size: 0.95rem; }
        .calendar-grid { padding: 10px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-name { font-size: 0.65rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .cal-day:hover:not(.disabled):not(.empty) { background: var(--primary-light); color: var(--primary); }
        .cal-day.active { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(2, 132, 199, 0.2); }
        .cal-day.today { border: 2px solid var(--primary); color: var(--primary); font-weight: 700; }
        .cal-day.today.active { border-color: white; }
        .cal-day.disabled { color: #cbd5e1; cursor: not-allowed; background: #f1f5f9; }
        .cal-day.empty { cursor: default; }
        .slots-header { padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .slots-list { padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .slot-item { padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; font-weight: 600; font-size: 0.85rem; cursor: pointer; position: relative; background: white; transition: 0.2s; }
        .slot-item:hover:not(.booked):not(.blocked) { border-color: var(--primary); color: var(--primary); }
        .slot-item.selected { background: var(--primary); color: white; border-color: var(--primary-dark); }
        .slot-item.booked { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; text-decoration: line-through; border-color: transparent; }
        .slot-item.blocked { background: #fee2e2; color: #ef4444; cursor: not-allowed; border: 1px solid #fecaca; opacity: 0.8; }
        .form-panel { padding: 20px; overflow-y: auto; }
        .live-summary { background: var(--primary-light); border: 1px solid var(--secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
        .live-summary h5 { font-size: 0.75rem; text-transform: uppercase; color: var(--primary-dark); margin-bottom: 8px; letter-spacing: 0.05em; }
        .live-summary-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; }

        .slot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 15px; }
        .slot-btn { padding: 10px; text-align: center; border: 2px solid #e2e8f0; border-radius: 12px; background: white; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 70px; transition: 0.2s; }
        .slot-btn:hover:not(.booked):not(.blocked) { border-color: var(--primary); color: var(--primary); }
        .slot-btn.blocked { border-color: #fca5a5; color: #ef4444; background: #fee2e2; }
        .slot-btn.booked { border-color: var(--primary); background: var(--info-bg); color: var(--primary-dark); cursor: not-allowed; }

        /* --- UI ELEMENTS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; padding: 20px; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 100%; max-width: 550px; border-radius: 20px; box-shadow: var(--shadow-lg); overflow: hidden; transform: scale(0.95); transition: 0.3s; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 10px; }

        .sales-summary { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; background: linear-gradient(135deg, var(--primary) 0%, #0369a1 100%); color: white; padding: 30px; border-radius: 20px; box-shadow: var(--shadow-md); }
        .sales-big-number { font-size: 2.5rem; font-weight: 800; line-height: 1; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1e293b; color: white; padding: 14px 28px; border-radius: 30px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 200; box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: 0.9rem; width: max-content; max-width: 90%; pointer-events: none; opacity: 0; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* --- PRINT STYLES --- */
        @media print {
            body { background: white; height: auto; overflow: visible; display: block; margin: 0; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .sidebar, header, .mobile-menu-btn, .no-print, .view-section:not(#view-bill-detail) { display: none !important; }
            .main-wrapper, .content-area { overflow: visible; height: auto; display: block; padding: 0; margin: 0; }
            #view-bill-detail { display: block !important; padding: 0; background: white; width: 100%; position: static; }
            .invoice-box { border: none; margin: 0; padding: 0; max-width: 100%; width: 100%; page-break-inside: avoid; box-shadow: none; }
            .invoice-top-bar { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            @page { size: A4 portrait; margin: 10mm; }
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 1024px) {
            .booking-container { grid-template-columns: 1fr 1fr; }
            .booking-panel:last-child { grid-column: span 2; }
            .bill-container { grid-template-columns: 1fr; }
            .bill-actions-area { order: -1; }
        }

        @media (max-width: 768px) {
            :root { --header-height: 60px; }
            body { position: relative; }
            .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; transform: translateX(-100%); z-index: 1050; box-shadow: var(--shadow-lg); }
            .sidebar.mobile-open { transform: translateX(0); }
            .sidebar-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1040; opacity: 0; pointer-events: none; transition: 0.3s; }
            .sidebar-backdrop.active { opacity: 1; pointer-events: auto; }
            .mobile-menu-btn { display: block; }
            .header-center { display: none; }
            .header-title p { display: block; }
            header { padding: 0 15px; grid-template-columns: auto 1fr auto; }
            .content-area { padding: 15px; }
            .dashboard-stats { grid-template-columns: 1fr 1fr; }
            .stat-card { padding: 20px; }
            .stat-card h3 { font-size: 1.5rem; }
            .booking-container { grid-template-columns: 1fr; height: auto; display: flex; flex-direction: column; }
            .booking-panel { height: auto; max-height: none; }
            .booking-panel:nth-child(1) { height: 350px; }
            .booking-panel:nth-child(2) { height: 250px; }
            .modal-content { max-width: 100%; height: 100%; border-radius: 0; max-height: 100vh; }
            .invoice-content { padding: 15px; }
            .invoice-header, .invoice-grid, .invoice-footer { flex-direction: column; gap: 15px; text-align: left !important; }
            .invoice-title-group, .right, .text-right { text-align: left !important; }
            .invoice-summary { justify-content: flex-start; }
            .invoice-summary-box { width: 100%; border: none; background: transparent; padding: 0; }
        }

        @media (max-width: 480px) {
            .dashboard-stats { grid-template-columns: 1fr; }
            .section-card { padding: 15px; }
            .table-header { flex-direction: column; align-items: flex-start; }
            .table-header-actions { flex-direction: column; align-items: stretch; width: 100%; }
            .search-container { max-width: 100%; }
            .pagination-bar { flex-direction: column; align-items: stretch; }
            .pagination-controls { width: 100%; justify-content: space-between; }
            .pagination-info { text-align: center; margin-bottom: 5px; }
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/ddnetwork-ent/clinic-azam-dental/main/IMG_2260.JPG" alt="Logo" class="logo-large">
            <h2 style="margin-top: 10px; margin-bottom: 5px; color: var(--primary-dark);">Klinik Azam</h2>
            <p style="margin-bottom: 30px; color: var(--text-light); font-weight: 500;">Cawangan (SP Saujana)</p>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div style="text-align:left; margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-light);">Username or Email</label>
                    <input type="text" id="username" class="form-input" placeholder="staff_username or email@example.com" required>
                </div>
                <div style="text-align:left; margin-bottom:25px;">
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-light);">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="password" required>
                </div>
                <button type="submit" class="btn-primary">Sign In <i class="fa-solid fa-arrow-right"></i></button>
                <div style="margin-top: 15px; font-size: 0.8rem; color: var(--text-light);">
                    Forgot password? Contact IT Support or use the chat widget.
                </div>
                <p id="loginError" style="color: var(--danger); font-size: 0.8rem; margin-top: 15px;"></p>
            </form>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="global-loader" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- MOBILE SIDEBAR BACKDROP -->
    <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleMobileMenu()"></div>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="brand">
            <img src="https://raw.githubusercontent.com/ddnetwork-ent/clinic-azam-dental/main/IMG_2260.JPG" alt="Logo" class="logo-img" style="margin-right:10px;">
            Klinik Pergigian Azam <br> SP Saujana
        </div>
        <ul class="nav-menu">
            <li class="nav-item" onclick="navigateTo('dashboard')"><i class="fa-solid fa-chart-pie"></i> Dashboard</li>
            <li class="nav-item" onclick="navigateTo('appointments')"><i class="fa-regular fa-calendar-check"></i> Appointments</li>
            <li class="nav-item" onclick="navigateTo('booking')"><i class="fa-solid fa-calendar-plus"></i> New Booking</li>
            <li class="nav-item" onclick="navigateTo('cashbill')"><i class="fa-solid fa-cash-register"></i> Cash Bill</li>
            <li class="nav-item" onclick="navigateTo('billing')"><i class="fa-solid fa-file-invoice-dollar"></i> Reports</li>
            <li class="nav-item" id="nav-staff" onclick="navigateTo('staff')" style="display:none;"><i class="fa-solid fa-users-cog"></i> Staff Management</li>
            <li class="nav-item" onclick="navigateTo('patients')"><i class="fa-solid fa-user-doctor"></i> Patients</li>
            <li class="nav-item" onclick="navigateTo('services')"><i class="fa-solid fa-notes-medical"></i> Services</li>
            <li class="nav-item" onclick="navigateTo('slots')"><i class="fa-regular fa-clock"></i> Slot Management</li>
        </ul>
        <div class="sidebar-footer">
            <div class="user-pill" onclick="openProfile()">
                <div class="avatar" id="userAvatar">DA</div>
                <div style="overflow:hidden;">
                    <div style="font-weight:700; font-size:0.85rem;" id="userNameDisplay">Dr. Amalina</div>
                    <div style="font-size:0.7rem; color:var(--text-light); text-overflow:ellipsis; overflow:hidden; white-space:nowrap;" id="userRoleDisplay">Admin</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-wrapper">
        <header>
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fa-solid fa-bars"></i></button>
                <div class="header-title">
                    <h2 id="pageTitle">Dashboard</h2>
                    <p style="color:var(--text-light); font-weight:500;" id="currentFullDate">Loading...</p>
                </div>
            </div>
            
            <div class="header-center">
                <div class="live-clock-container">
                    <i class="fa-regular fa-clock" style="color: var(--primary); font-size:1.1rem;"></i>
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        <span id="liveClock" class="live-time">00:00:00</span>
                        <span id="liveDate" class="live-date-header">Loading Date</span>
                    </div>
                </div>
            </div>

            <div class="header-right">
                <button onclick="logout()" class="btn-sm" style="color: var(--danger); border-color: #fee2e2; padding: 8px 12px;"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <div class="content-area">
            
            <!-- DASHBOARD -->
            <section id="view-dashboard" class="view-section active">
                <div class="dashboard-stats">
                    <div class="section-card stat-card">
                        <div><h3 style="margin-bottom:5px;" id="d-stat-today">0</h3><p>Today's Appts</p></div>
                        <div class="stat-icon" style="background:var(--primary-light); color:var(--primary);"><i class="fa-regular fa-calendar"></i></div>
                    </div>
                    <div class="section-card stat-card">
                        <div><h3 style="margin-bottom:5px;" id="d-stat-sales">RM 0</h3><p>Today's Sales</p></div>
                        <div class="stat-icon" style="background:var(--success-bg); color:var(--success);"><i class="fa-solid fa-coins"></i></div>
                    </div>
                    <div class="section-card stat-card">
                        <div><h3 style="margin-bottom:5px;" id="d-stat-history">0</h3><p>Total Patients</p></div>
                        <div class="stat-icon" style="background:var(--warning-bg); color:var(--warning);"><i class="fa-solid fa-users"></i></div>
                    </div>
                </div>
                <div class="section-card" style="position:relative;">
                    <div class="loading-overlay" id="dash-loader"><div class="spinner"></div></div>
                    <div class="table-header"><h3><i class="fa-solid fa-clock" style="color:var(--primary); margin-right:8px;"></i>Today's Schedule</h3></div>
                    <div class="table-responsive"><table id="dashboard-table"><thead><tr><th>Time</th><th>Patient</th><th>Service</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- APPOINTMENTS -->
            <section id="view-appointments" class="view-section">
                <!-- Upcoming Schedule -->
                <div class="section-card" style="position:relative;">
                    <div class="loading-overlay"><div class="spinner"></div></div>
                    <div class="table-header">
                        <h3>Upcoming Schedule</h3>
                        <div class="table-header-actions">
                            <div class="search-container">
                                <i class="fa-solid fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search name, date, service..." oninput="handleSearch('appointments', this.value)">
                            </div>
                            <select class="sort-select" onchange="handleSort('appointments', this.value)">
                                <option value="desc">Newest First</option>
                                <option value="asc">Oldest First</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive"><table id="today-table"><thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Phone</th><th>Service</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                    <!-- Pagination Container -->
                    <div id="pag-appointments-upcoming" class="pagination-bar"></div>
                </div>

                <!-- Patient History (Completed) -->
                <div class="section-card" style="position:relative;">
                    <div class="loading-overlay"><div class="spinner"></div></div>
                    <div class="table-header">
                        <h3>Patient History (Completed)</h3>
                        <div class="table-header-actions">
                            <div class="search-container">
                                <i class="fa-solid fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search history..." oninput="handleSearch('history', this.value)">
                            </div>
                            <select class="sort-select" onchange="handleSort('history', this.value)">
                                <option value="desc">Newest First</option>
                                <option value="asc">Oldest First</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive"><table id="history-table"><thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Service</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                    <!-- Pagination Container -->
                    <div id="pag-appointments-history" class="pagination-bar"></div>
                </div>

                <!-- Cancelled -->
                <div class="section-card" style="border-left: 4px solid var(--danger); position:relative;">
                    <div class="loading-overlay"><div class="spinner"></div></div>
                    <div class="table-header">
                        <h3 style="color:var(--danger);"><i class="fa-solid fa-ban" style="margin-right:8px;"></i> Cancelled</h3>
                        <button class="btn-sm" id="toggleCancelledBtn" onclick="toggleCancelledTable()">Show Cancelled</button>
                    </div>
                    <div id="cancelled-container" style="display:none;">
                        <div class="table-responsive"><table id="cancelled-table"><thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Service</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                        <!-- Pagination Container -->
                        <div id="pag-appointments-cancelled" class="pagination-bar"></div>
                    </div>
                </div>
            </section>

            <!-- CASH BILL (IMPROVED) -->
            <section id="view-cashbill" class="view-section">
                <!-- Cashbill List View (Default) -->
                <div id="cashbill-list-view">
                    <div class="section-card">
                        <div class="table-header">
                            <h3><i class="fa-solid fa-file-invoice-dollar" style="color:var(--primary); margin-right:8px;"></i>Completed Cashbills / Invoices</h3>
                            <div class="table-header-actions">
                                <button class="btn-primary" style="width:auto;" onclick="toggleCashbillCreate(true)"><i class="fa-solid fa-plus"></i> Create Cashbill</button>
                                <div class="search-container">
                                    <i class="fa-solid fa-search search-icon"></i>
                                    <input type="text" class="search-input" placeholder="Search invoices..." oninput="handleSearch('cashbill', this.value)">
                                </div>
                                <select class="sort-select" onchange="handleSort('cashbill', this.value)">
                                    <option value="desc">Newest First</option>
                                    <option value="asc">Oldest First</option>
                                </select>
                            </div>
                        </div>
                        <div class="loading-overlay"><div class="spinner"></div></div>
                        <div class="table-responsive"><table id="cashbill-table"><thead><tr><th>Invoice #</th><th>Date</th><th>Patient</th><th>Total (RM)</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                        <!-- Pagination Container -->
                        <div id="pag-cashbill" class="pagination-bar"></div>
                    </div>
                </div>

                <!-- Cashbill Create View (Hidden by default) -->
                <div id="cashbill-create-view" style="display:none;">
                    <div class="section-card">
                        <div class="table-header">
                            <h3><i class="fa-solid fa-cash-register" style="color:var(--success); margin-right:8px;"></i>New Cash Bill</h3>
                            <button class="btn-sm" onclick="toggleCashbillCreate(false)"><i class="fa-solid fa-arrow-left"></i> Back to List</button>
                        </div>

                        <div class="bill-container">
                            <!-- Left: Patient & Service Selection -->
                            <div>
                                <h4 style="margin-bottom:15px; color:var(--primary); font-size:1rem;">Patient Selection</h4>
                                <div class="custom-select-wrapper" style="margin-bottom:20px;">
                                    <div class="custom-select-header">
                                        <input type="text" id="cb-pat-search" class="custom-select-input" placeholder="Search Name or Phone..." autocomplete="off">
                                        <i class="fa-solid fa-circle-xmark clear-selection" id="clear-cb-pat" onclick="clearCashBillPatient()"></i>
                                    </div>
                                    <ul id="cb-pat-list" class="options-list"></ul>
                                    <input type="hidden" id="cb-pat-id">
                                </div>

                                <div id="cb-pat-details" style="display:none; background:#f8fafc; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid #e2e8f0;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--text-light);">Name</span><span style="font-weight:700;" id="cb-p-name">-</span></div>
                                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--text-light);">IC</span><span style="font-weight:600;" id="cb-p-ic">-</span></div>
                                    <div style="display:flex; justify-content:space-between;"><span style="color:var(--text-light);">Phone</span><span style="font-weight:600;" id="cb-p-phone">-</span></div>
                                </div>

                                <h4 style="margin-bottom:15px; color:var(--primary); font-size:1rem;">Add Services</h4>
                                <div style="margin-bottom:15px;">
                                    <select id="cb-service-select" class="form-input" onchange="addToCashBill()">
                                        <option value="" disabled selected>-- Select Service to Add --</option>
                                    </select>
                                </div>

                                <div class="table-responsive">
                                    <table id="cb-items-table">
                                        <thead><tr><th>Item</th><th>Price</th><th>Action</th></tr></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Right: Payment & Actions -->
                            <div class="bill-actions-area">
                                <div class="section-card" style="padding:20px;">
                                    <h4 style="margin-bottom:10px;">Total Due</h4>
                                    <div style="font-size:2rem; font-weight:800; color:var(--primary);">RM <span id="cb-total-display">0.00</span></div>
                                </div>

                                <div class="payment-type-selector">
                                    <div class="pay-type active" id="pay-cash" onclick="setPaymentType('CASH')">
                                        <i class="fa-solid fa-money-bill-wave"></i> Cash
                                    </div>
                                    <div class="pay-type" id="pay-qr" onclick="setPaymentType('QR')">
                                        <i class="fa-solid fa-qrcode"></i> QR/Transfer
                                    </div>
                                </div>

                                <div id="payment-inputs" style="display:none; margin-bottom:15px;">
                                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-light); display:block;">Amount Received</label>
                                    <input type="number" id="cb-amount-received" class="form-input" placeholder="0.00" oninput="calculateBalance()">
                                </div>

                                <div id="balance-display" style="text-align:center; font-weight:700; font-size:1.1rem; margin-bottom:15px; color:var(--danger); display:none;">
                                    Change: RM <span id="cb-balance">0.00</span>
                                </div>

                                <button class="btn-primary" id="cb-save-btn" onclick="saveCashBill()" disabled>Generate Bill & Print</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- REPORTS -->
            <section id="view-billing" class="view-section">
                <div class="sales-summary">
                    <div>
                        <p style="opacity:0.9; font-weight:600; margin-bottom:5px; font-size:0.9rem;">Total Billed (Selected Period)</p>
                        <div class="sales-big-number">RM <span id="billing-total-amount">0.00</span></div>
                    </div>
                    <div style="text-align:right;">
                        <i class="fa-solid fa-file-invoice-dollar" style="font-size:3rem; opacity:0.2;"></i>
                    </div>
                </div>

                <div class="section-card">
                    <div class="table-header">
                        <h3>Billing Filter</h3>
                        <div class="table-header-actions" style="flex-wrap: wrap; gap: 10px;">
                            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                                <div>
                                    <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); display:block;">From</label>
                                    <input type="date" id="billing-start" class="form-input" style="padding: 10px;" onchange="renderBilling()">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); display:block;">To</label>
                                    <input type="date" id="billing-end" class="form-input" style="padding: 10px;" onchange="renderBilling()">
                                </div>
                            </div>
                            <button class="btn-primary" style="width:auto; white-space:nowrap; padding: 10px 20px;" onclick="exportBillingData()"><i class="fa-solid fa-download"></i> Download CSV</button>
                        </div>
                    </div>
                </div>

                <div class="section-card" style="position:relative;">
                    <div class="loading-overlay"><div class="spinner"></div></div>
                    <div class="table-header">
                        <h3>Patient Bills</h3>
                        <div class="table-header-actions">
                             <div class="search-container">
                                <i class="fa-solid fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search invoice, patient..." oninput="handleSearch('billing', this.value)">
                            </div>
                            <select class="sort-select" onchange="handleSort('billing', this.value)">
                                <option value="desc">Newest First</option>
                                <option value="asc">Oldest First</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive"><table id="billing-table"><thead><tr><th>Invoice #</th><th>Date</th><th>Patient</th><th>Phone</th><th>Items</th><th>Total (RM)</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                    <!-- Pagination Container -->
                    <div id="pag-billing" class="pagination-bar"></div>
                </div>
            </section>

            <!-- PROFESSIONAL INVOICE (UPDATED LAYOUT) -->
            <section id="view-bill-detail" class="view-section">
                <div class="no-print" style="margin-bottom: 20px;">
                    <button class="btn-sm" onclick="navigateTo('cashbill')"><i class="fa-solid fa-arrow-left"></i> Back to Cash Bills</button>
                </div>

                <div class="invoice-box">
                    <!-- Top Bar -->
                    <div class="invoice-top-bar"></div>

                    <div class="invoice-content">
                        <!-- HEADER -->
                        <div class="invoice-header">
                            <div class="invoice-brand">
                                <h2>KLINIK PERGIGIAN AZAM</h2>
                                <p>Cawangan (SP Saujana)</p>
                                <p>21, Jalan PKS (A), Pusat Komersial Saujana</p>
                                <p>08000 Sungai Petani, Kedah</p>
                                <p>Tel: 04-123 4567</p>
                            </div>
                            <div class="invoice-title-group">
                                <h1>INVOICE</h1>
                                <span>Invoice No: <span id="inv-no">KPA-000</span></span>
                                <span>Date: <span id="inv-date">--/--/----</span></span>
                            </div>
                        </div>

                        <!-- INFO GRID -->
                        <div class="invoice-grid">
                            <div>
                                <h4>BILL TO</h4>
                                <p><strong id="inv-p-name">Patient Name</strong></p>
                                <p id="inv-p-ic">IC / Passport No</p>
                                <p id="inv-p-phone">01X-XXXXXXX</p>
                            </div>
                            <div>
                                <h4>INVOICE DETAILS</h4>
                                <p>Payment Method: <span id="inv-payment">Cash</span></p>
                                <p>Attending Doctor: Dr. Amalina</p>
                            </div>
                        </div>

                        <!-- ITEM TABLE -->
                        <table class="item-table">
                            <thead>
                                <tr>
                                    <th style="width:5%">No</th>
                                    <th>Description</th>
                                    <th style="width:10%">Qty</th>
                                    <th style="width:15%">Unit (RM)</th>
                                    <th style="width:15%" class="right">Amount (RM)</th>
                                </tr>
                            </thead>
                            <tbody id="inv-items-body">
                                <!-- JS Injected -->
                            </tbody>
                        </table>

                        <!-- TOTALS -->
                        <div class="invoice-summary">
                            <div class="invoice-summary-box">
                                <div class="summary-row">
                                    <span>Subtotal</span>
                                    <span id="inv-subtotal">RM 0.00</span>
                                </div>
                                <div class="summary-row">
                                    <span>SST (0%)</span>
                                    <span>RM 0.00</span>
                                </div>
                                <div class="summary-row total">
                                    <span>Total Due</span>
                                    <span id="inv-total">RM 0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- FOOTER -->
                        <div class="invoice-footer">
                            <div>
                                <strong>Payment Details</strong><br>
                                Maybank  XXXXXXXX
                            </div>
                            <div>
                                This invoice is system-generated.<br>
                                No signature required.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="no-print" style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                     <button class="btn-sm" onclick="openEditInvoiceFromPage()"><i class="fa-solid fa-pen"></i> Edit Items</button>
                     <button class="btn-primary" style="width: auto; padding: 10px 24px;" onclick="window.print()"><i class="fa-solid fa-print"></i> Print Invoice</button>
                </div>
            </section>

            <!-- STAFF MANAGEMENT (RESTRICTED + SUPERADMIN TABLE) -->
            <section id="view-staff" class="view-section">
                <!-- Regular Staff Table -->
                <div class="section-card" style="position:relative;">
                    <div class="loading-overlay"><div class="spinner"></div></div>
                    <div class="table-header">
                        <h3><i class="fa-solid fa-users-cog" style="color:var(--primary); margin-right:8px;"></i>Staff Management</h3>
                        <div class="table-header-actions">
                            <button class="btn-sm" id="btn-add-staff" onclick="openEditStaff(null)"><i class="fa-solid fa-user-plus"></i> Add Staff</button>
                            <div class="search-container">
                                <i class="fa-solid fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search staff..." oninput="handleSearch('staff', this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive"><table id="staff-table"><thead><tr><th>ID</th><th>Name</th><th>Job Title</th><th>Role</th><th>Username/Email</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                    <!-- Pagination Container -->
                    <div id="pag-staff" class="pagination-bar"></div>
                </div>

                <!-- SuperAdmin / System Developer Table (Improved Styling) -->
                <div class="section-card super-admin-card">
                     <div class="table-header">
                        <h3><i class="fa-solid fa-user-shield" style="color:var(--danger); margin-right:8px;"></i>SuperAdmin / System Developer</h3>
                    </div>
                    <div class="table-responsive"><table id="superadmin-table"><thead><tr><th>ID</th><th>Name</th><th>Job Title</th><th>Role</th><th>Username/Email</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- PATIENTS -->
            <section id="view-patients" class="view-section">
                <div class="section-card" style="position:relative;">
                    <div class="loading-overlay"><div class="spinner"></div></div>
                    <div class="table-header">
                        <h3>Patient Directory</h3>
                        <div class="table-header-actions">
                            <button class="btn-sm" onclick="openEditPatient(null)"><i class="fa-solid fa-user-plus"></i> Add Patient</button>
                            <div class="search-container">
                                <i class="fa-solid fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search name, phone, IC..." oninput="handleSearch('patients', this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive"><table id="patients-table"><thead><tr><th>Name</th><th>Phone</th><th>IC No.</th><th>Visits</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                    <!-- Pagination Container -->
                    <div id="pag-patients" class="pagination-bar"></div>
                </div>
            </section>

            <!-- SERVICES -->
            <section id="view-services" class="view-section">
                <div class="section-card" style="position:relative;">
                    <div class="loading-overlay"><div class="spinner"></div></div>
                    <div class="table-header">
                        <h3>Clinic Services & Pricing</h3>
                        <div class="table-header-actions">
                            <button class="btn-sm" onclick="openEditService(null)"><i class="fa-solid fa-plus"></i> Add Service</button>
                        </div>
                    </div>
                    <div class="table-responsive"><table id="services-table"><thead><tr><th>Service</th><th>Price</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- SLOTS -->
            <section id="view-slots" class="view-section">
                <div class="section-card">
                    <div class="table-header">
                        <h3>Manage Availability</h3>
                        <button class="btn-sm" onclick="toggleClinicStatus()" id="clinicStatusBtn"><i class="fa-solid fa-toggle-on"></i> Set as Closed</button>
                    </div>
                    <div class="table-header-actions" style="margin-bottom:10px;">
                        <input type="date" id="slotDate" class="form-input" style="width:auto;" onchange="renderSlots()">
                    </div>
                    <p style="font-size:0.75rem; color:var(--text-light); margin-bottom:10px;">
                        <span style="font-weight:700; color:var(--primary);">Blue</span> = Booked | 
                        <span style="font-weight:700; color:var(--danger);">Red</span> = Break | 
                        <span style="font-weight:700; color:var(--text-light);">White</span> = Available
                    </p>
                    <div class="slot-grid" id="slotGrid"></div>
                </div>
            </section>

             <!-- BOOKING -->
             <section id="view-booking" class="view-section">
                <div class="section-card">
                    <div class="table-header" style="margin-bottom:0;">
                        <h3><i class="fa-solid fa-calendar-plus" style="color:var(--primary); margin-right:8px;"></i>New Appointment</h3>
                        <button class="btn-sm" onclick="resetBookingForm()">Reset</button>
                    </div>
                    
                    <form id="newBookingForm" onsubmit="saveNewBooking(event)" style="margin-top:20px;">
                        <div class="booking-container">
                            <!-- 1. CALENDAR -->
                            <div class="booking-panel">
                                <div class="calendar-header">
                                    <button type="button" onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                                    <span class="month-label" id="cal-month-year">January 2024</span>
                                    <button type="button" onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                                </div>
                                <div class="calendar-grid">
                                    <div class="cal-day-name">Su</div><div class="cal-day-name">Mo</div><div class="cal-day-name">Tu</div><div class="cal-day-name">We</div><div class="cal-day-name">Th</div><div class="cal-day-name">Fr</div><div class="cal-day-name">Sa</div>
                                </div>
                                <div class="calendar-grid" id="calendar-days" style="margin-top:0;"></div>
                            </div>

                            <!-- 2. SLOTS -->
                            <div class="booking-panel">
                                <div class="slots-header">
                                    <h4 id="slot-date-display">Select a Date</h4>
                                    <span id="slot-sub-display">Available times will appear here</span>
                                </div>
                                <div class="slots-list" id="booking-slots-list">
                                    <div style="text-align:center; color:var(--text-light); margin-top:30px; font-size:0.85rem;">
                                        <i class="fa-regular fa-calendar" style="font-size:1.5rem; margin-bottom:8px; opacity:0.3;"></i><br>
                                        Select date from calendar
                                    </div>
                                </div>
                            </div>

                            <!-- 3. FORM -->
                            <div class="booking-panel">
                                <div class="form-panel">
                                    <div class="live-summary">
                                        <h5>Booking Summary</h5>
                                        <div class="live-summary-row"><span>Date:</span> <span class="live-summary-val" id="summary-date">-</span></div>
                                        <div class="live-summary-row"><span>Time:</span> <span class="live-summary-val" id="summary-time">-</span></div>
                                        <div class="live-summary-row"><span>Service:</span> <span class="live-summary-val" id="summary-service">-</span></div>
                                    </div>

                                    <h4 style="margin-bottom:15px; color:var(--primary); font-size:1rem;">Patient Selection</h4>
                                    
                                    <div style="display:flex; gap: 20px; margin-bottom: 15px; background: #f1f5f9; padding: 10px; border-radius: 8px;">
                                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-weight:600; color: var(--primary);">
                                            <input type="radio" name="patType" value="new" onchange="togglePatientType()"> New Patient
                                        </label>
                                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-weight:600; color: var(--primary);">
                                            <input type="radio" name="patType" value="old" checked onchange="togglePatientType()"> Existing Patient
                                        </label>
                                    </div>

                                    <!-- Mode: New Patient -->
                                    <div id="new-pat-inputs" style="display:none;">
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-light); margin-bottom:4px; display:block;">Full Name</label>
                                            <input type="text" id="bk-name" class="form-input" placeholder="Full Name">
                                        </div>
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-light); margin-bottom:4px; display:block;">Phone Number</label>
                                            <input type="tel" id="bk-phone" class="form-input" placeholder="012-3456789">
                                        </div>
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-light); margin-bottom:4px; display:block;">IC Number</label>
                                            <input type="text" id="bk-ic" class="form-input" placeholder="Optional">
                                        </div>
                                    </div>

                                    <!-- Mode: Existing Patient (Default) -->
                                    <div id="old-pat-inputs">
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-light); margin-bottom:4px; display:block;">Select Patient</label>
                                            
                                            <!-- CUSTOM SEARCHABLE DROPDOWN -->
                                            <div class="custom-select-wrapper">
                                                <div class="custom-select-header">
                                                    <input type="text" id="bk-pat-search" class="custom-select-input" placeholder="Search Name or Phone..." autocomplete="off">
                                                    <i class="fa-solid fa-circle-xmark clear-selection" id="clear-pat-search" onclick="clearPatientSelection()"></i>
                                                </div>
                                                <ul id="bk-pat-list" class="options-list"></ul>
                                                <input type="hidden" id="bk-pat-select">
                                            </div>
                                        </div>
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-light); margin-bottom:4px; display:block;">Phone (Review)</label>
                                            <input type="text" id="bk-review-phone" class="form-input" disabled placeholder="Auto-filled">
                                        </div>
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-light); margin-bottom:4px; display:block;">IC (Review)</label>
                                            <input type="text" id="bk-review-ic" class="form-input" disabled placeholder="Auto-filled">
                                        </div>
                                    </div>

                                    <h4 style="margin:20px 0 15px; color:var(--primary); font-size:1rem;">Service</h4>
                                    <div style="margin-bottom:15px;">
                                        <select id="bk-service" class="form-input" onchange="checkBookingFormComplete()">
                                            <option value="" disabled selected>-- Choose Service --</option>
                                        </select>
                                    </div>

                                    <div style="margin-top:15px;">
                                        <button type="submit" class="btn-primary" id="confirm-booking-btn" disabled>Add New Appointment</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

        </div>
    </div>

    <!-- MODALS -->
    <!-- 1. Edit Appointment Modal -->
    <div class="modal-overlay" id="editApptModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Edit Appointment</h3><button onclick="closeModal('editApptModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-appt-id">
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Date</label><input type="date" id="edit-appt-date" class="form-input" onchange="updateEditTimeOptions()"></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Time</label><select id="edit-appt-time" class="form-input"></select></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Service</label><select id="edit-appt-service" class="form-input"></select></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editApptModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="saveApptEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- 2. Edit Service Modal -->
    <div class="modal-overlay" id="editServiceModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="service-modal-title">Add Service</h3><button onclick="closeModal('editServiceModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-service-id">
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Service Name</label><input type="text" id="edit-service-name" class="form-input"></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Price (RM)</label><input type="number" id="edit-service-price" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editServiceModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="saveServiceEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- 3. Staff Edit Modal (UPDATED FOR AUTH) -->
    <div class="modal-overlay" id="editStaffModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="staff-modal-title">Manage Staff</h3><button onclick="closeModal('editStaffModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-staff-id">
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:700;">Smart ID (Auto)</label>
                    <input type="text" id="edit-staff-sid" class="form-input" placeholder="KPA-000" disabled style="background:#f1f5f9; font-family:'Poppins', monospace;">
                </div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Staff Name</label><input type="text" id="edit-staff-name" class="form-input"></div>
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:700;">Job Title</label>
                    <select id="edit-staff-jobtitle" class="form-input">
                        <option value="Dentist">Dentist</option>
                        <option value="Nurse">Nurse</option>
                        <option value="Assistant">Assistant</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:700;">Role</label>
                    <select id="edit-staff-role" class="form-input">
                        <option value="Staff">Staff</option>
                        <option value="Admin">Admin</option>
                        <option value="SuperAdmin">SuperAdmin</option>
                    </select>
                </div>
                
                <!-- Email & Username for Auth -->
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Email <span style="color:var(--danger)">*</span></label><input type="email" id="edit-staff-email" class="form-input" placeholder="staff@clinic.com"></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Username</label><input type="text" id="edit-staff-u" class="form-input"></div>
                
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:700;">Password</label>
                    <input type="password" id="edit-staff-p" class="form-input" placeholder="Leave blank to keep current (or fill for new user)">
                    <small style="color:var(--text-light); display:block; margin-top:4px;">Min 6 chars.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editStaffModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="saveStaffEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- 4. Patient Details & Manual History Modal -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Patient Details</h3>
                <button onclick="closeModal('historyModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div style="background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #e2e8f0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--text-light);">Name</span><span style="font-weight:700;" id="hist-p-name">-</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--text-light);">ID</span><span style="font-weight:600;" id="hist-p-id">-</span></div>
                    <div style="display:flex; justify-content:space-between;"><span style="color:var(--text-light);">Phone</span><span style="font-weight:600;" id="hist-p-phone">-</span></div>
                </div>

                <div style="margin-bottom:20px; border-top:1px dashed #e2e8f0; padding-top:15px;">
                    <h4 style="font-size:0.9rem; margin-bottom:10px; color:var(--primary);"><i class="fa-solid fa-clock-rotate-left"></i> Add Past Visit (Manual Entry)</h4>
                    <div style="display:grid; gap:10px;">
                        <input type="date" id="hist-date" class="form-input" style="padding:8px;">
                        <select id="hist-service" class="form-input" style="padding:8px;">
                            <option value="" disabled selected>Select Service</option>
                        </select>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="hist-qty" class="form-input" placeholder="Qty" value="1" style="width:60px; padding:8px;">
                            <input type="number" id="hist-price" class="form-input" placeholder="Price (RM)" style="padding:8px;">
                        </div>
                        <button class="btn-sm btn-bill" onclick="saveManualHistory()" style="width:100%; justify-content:center;">Add to History</button>
                    </div>
                </div>

                <h5 style="margin-bottom:10px;">Visit History</h5>
                <div class="table-responsive" style="border:none;"><table style="font-size:0.85rem;"><thead><tr><th>Date</th><th>Service</th><th>Amount</th></tr></thead><tbody id="historyListBody"></tbody></table></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('historyModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- 5. PROFILE MODAL -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>My Profile</h3>
                <button onclick="closeModal('profileModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 20px;">
                <div style="text-align: center; background: linear-gradient(135deg, var(--primary-light), white); padding: 30px; border-radius: 16px;">
                    <div class="avatar" style="width: 80px; height: 80px; font-size: 1.8rem; margin: 0 auto 15px; border: 4px solid white; box-shadow: var(--shadow-md);" id="profile-avatar">DA</div>
                    <h4 id="profile-name" style="font-size: 1.2rem; margin-bottom: 5px;">Dr. Amalina</h4>
                    <span id="profile-role" class="badge badge-info" style="font-size: 0.8rem;">Admin</span>
                </div>
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                    <h5 style="margin-bottom: 15px; color: var(--primary);">Account Details</h5>
                    <div style="display: grid; gap: 12px;">
                        <div><label style="font-size: 0.75rem; color: var(--text-light);">Username</label><div style="font-weight: 600; font-size: 1rem;" id="profile-u">amalina</div></div>
                        <div><label style="font-size: 0.75rem; color: var(--text-light);">Email</label><div style="font-weight: 600; font-size: 1rem;" id="profile-email">admin@azam.com</div></div>
                        <div><label style="font-size: 0.75rem; color: var(--text-light);">Employee ID</label><div style="font-weight: 600; font-size: 1rem;" id="profile-id">EMP001</div></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-sm" onclick="closeModal('profileModal')">Close</button></div>
        </div>
    </div>

    <!-- 6. EDIT INVOICE MODAL -->
    <div class="modal-overlay" id="invoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-file-invoice-dollar"></i> Edit Invoice</h3>
                <button onclick="closeModal('invoiceModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div style="background:#f8fafc; padding:12px; border-radius:10px; margin-bottom:12px; border:1px solid #e2e8f0; font-size:0.85rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--text-light);">Patient</span><span style="font-weight:700;" id="bill-p-name">-</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--text-light);">Date</span><span style="font-weight:600;" id="bill-date">-</span></div>
                    <div style="display:flex; justify-content:space-between;"><span style="color:var(--text-light);">Phone</span><span style="font-weight:600;" id="bill-phone">-</span></div>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:700; display:block; margin-bottom:5px;">Payment Method</label>
                    <select id="bill-payment-method" class="form-input">
                        <option value="CASH">Cash</option>
                        <option value="QR">QR Code (DuitNow/TouchNGo)</option>
                        <option value="BANK TRANSFER">Bank Transfer</option>
                    </select>
                </div>
                <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-size:0.8rem; font-weight:700;">Services</label>
                    <button class="btn-sm" onclick="addInvoiceItem()" style="font-size:0.75rem; padding:6px 10px;">+ Add</button>
                </div>
                <div class="table-responsive" style="border:none; margin-bottom:15px;"><table class="invoice-table" style="font-size:0.85rem;"><thead><tr><th style="width:40%">Item</th><th style="width:20%; text-align:right">Qty</th><th style="width:20%; text-align:right">Price</th><th style="width:20%; text-align:right">Total</th><th></th></tr></thead><tbody id="bill-items-body"></tbody></table></div>
                <div style="text-align:right; padding-top:15px; border-top:2px solid #e2e8f0;">
                    <span style="color:var(--text-light); font-size:0.85rem;">Grand Total</span>
                    <div style="font-size:1.5rem; font-weight:800; color:var(--primary); margin-top:5px;">RM <span id="bill-grand-total">0.00</span></div>
                </div>
            </div>
            <div class="modal-footer no-print">
                <button class="btn-sm" onclick="closeModal('invoiceModal')">Cancel</button>
                <button class="btn-sm btn-bill" onclick="saveAndPrintInvoice()">Save & Refresh</button>
            </div>
        </div>
    </div>

    <!-- 7. EDIT PATIENT MODAL -->
    <div class="modal-overlay" id="editPatientModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="patient-modal-title">Add Patient</h3><button onclick="closeModal('editPatientModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-patient-id">
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Full Name</label><input type="text" id="edit-patient-name" class="form-input"></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Phone</label><input type="tel" id="edit-patient-phone" class="form-input"></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">IC</label><input type="text" id="edit-patient-ic" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editPatientModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="savePatientEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- 8. CONFIRM CANCEL MODAL -->
    <div class="modal-overlay" id="confirmCancelModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 style="color: var(--danger);">Cancel Appointment?</h3>
                <button onclick="closeModal('confirmCancelModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Are you sure you want to cancel this appointment? This action cannot be undone.</p>
                <input type="hidden" id="cancel-appt-id">
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('confirmCancelModal')">No, Keep It</button>
                <button class="btn-sm btn-delete" onclick="executeCancel()">Yes, Cancel It</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast">
        <i class="fa-solid fa-circle-check" style="color:#4ade80;"></i> 
        <span id="toastMsg">Action Successful</span>
    </div>
    
    <!-- OPENWIDGET SCRIPT -->
    <script>
      window.__ow = window.__ow || {};
      window.__ow.organizationId = "5f28e53d-8b59-4e4b-881a-befc6c4b6d45";
      window.__ow.integration_name = "manual_settings";
      window.__ow.product_name = "openwidget";   
      ;(function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[OpenWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.openwidget.com/openwidget.js",t.head.appendChild(n)}};!n.__ow.asyncInit&&e.init(),n.OpenWidget=n.OpenWidget||e}(window,document,[].slice))
    </script>
    <noscript>You need to <a href="https://www.openwidget.com/enable-javascript" rel="noopener nofollow">enable JavaScript</a> to use communication tool powered by <a href="https://www.openwidget.com/" rel="noopener nofollow" target="_blank">OpenWidget</a></noscript>
    <!-- End of OpenWidget code -->

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBkH-3VaTJHVHSCROb2rIf5H03yZa3GYOo",
            authDomain: "ddcloudnetwork.firebaseapp.com",
            projectId: "ddcloudnetwork",
            storageBucket: "ddcloudnetwork.firebasestorage.app",
            messagingSenderId: "692579973408",
            appId: "1:692579973408:web:027492492ddf57dbf3bf45",
            measurementId: "G-58N4W6Y5CN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- GLOBAL STATE ---
        let currentUser = null;
        let patients = []; 
        let services = [];
        let staff = [];
        let appointments = [];
        let slotExceptions = []; 

        const SESSION_KEY = 'clinicUser';
        const todayStr = new Date().toISOString().split('T')[0];
        
        // MIN BOOKING DATE IS TOMORROW (Request: Cannot booking on the same day)
        const todayObj = new Date();
        const tomorrowObj = new Date(todayObj);
        tomorrowObj.setDate(tomorrowObj.getDate() + 1);
        const minBookingDate = tomorrowObj.toISOString().split('T')[0];

        let currentCalDate = new Date();
        let selectedBookingDate = null;
        let selectedBookingTime = null;
        let currentBillAppt = null;
        let historyPatientId = null;

        // Sort State (Default: Newest First)
        let sortState = {
            appointments: 'desc',
            history: 'desc',
            cashbill: 'desc',
            billing: 'desc'
        };

        // --- PAGINATION STATE ---
        // Keys correspond to table IDs
        let paginationConfig = {
            'appointments-upcoming': { page: 1, limit: 10 },
            'appointments-history': { page: 1, limit: 10 },
            'appointments-cancelled': { page: 1, limit: 10 },
            'cashbill': { page: 1, limit: 10 },
            'billing': { page: 1, limit: 10 },
            'staff': { page: 1, limit: 10 },
            'patients': { page: 1, limit: 10 }
        };

        // Cash Bill State
        let currentCashBillItems = [];
        let cashBillPaymentType = 'CASH';
        let cashBillPatientId = null;
        let isCashbillCreateView = false;

        const defaultSlots = ["09:00 AM", "09:30 AM", "10:00 AM", "10:30 AM", "11:00 AM", "11:30 AM", "12:00 PM", "02:00 PM", "02:30 PM", "03:00 PM", "03:30 PM", "04:00 PM", "04:30 PM", "05:00 PM", "05:30 PM"];
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Auth State Listener
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in, fetch staff details
                    const staffDoc = await db.collection('klinikazam_staff').doc(user.email).get(); // Assume email is stored as doc ID or we search
                    // Better approach: Query staff by email
                    const q = await db.collection('klinikazam_staff').where('email', '==', user.email).get();
                    
                    if(!q.empty) {
                        currentUser = { id: q.docs[0].id, ...q.docs[0].data(), uid: user.uid };
                        setupUserUI(currentUser);
                        document.getElementById('login-screen').classList.add('hidden');
                        setTimeout(() => document.getElementById('login-screen').style.display = 'none', 500);
                        startLiveClock();
                        showLoading(true);
                        await refreshData(); 
                        showLoading(false);
                        navigateTo('dashboard');
                    } else {
                        // Auth user exists but no DB record (should not happen if signup logic is correct)
                        showToast("Error: Staff record not found.");
                        auth.signOut();
                    }
                } else {
                    // User is signed out
                    // Check local session? No, we rely on Firebase Auth now.
                    document.getElementById('login-screen').classList.remove('hidden');
                }
            });

            window.onmousemove = resetInactivityTimer;
            window.onkeypress = resetInactivityTimer;
            window.onclick = resetInactivityTimer;
            window.onscroll = resetInactivityTimer;
        });

        // --- UI HELPERS ---
        function showLoading(show) {
            const loader = document.getElementById('global-loader');
            if(loader) loader.classList.toggle('active', show);
            
            document.querySelectorAll('.loading-overlay').forEach(el => {
                if(show && el.closest('.view-section.active')) el.classList.add('active');
                else el.classList.remove('active');
            });
        }

        // --- SMART ID GENERATOR ---
        async function generateSmartId(collection, prefix) {
            const snapshot = await db.collection(collection)
                .orderBy('id', 'desc')
                .limit(1)
                .get();
            
            let nextNum = 1;
            if (!snapshot.empty) {
                const lastDoc = snapshot.docs[0];
                const lastId = lastDoc.id; // Assuming ID field matches Doc ID for Smart ID
                const parts = lastId.split('-');
                const lastNum = parseInt(parts[parts.length - 1]);
                if (!isNaN(lastNum)) {
                    nextNum = lastNum + 1;
                }
            }
            
            const numStr = String(nextNum).padStart(3, '0'); 
            return `${prefix}-${numStr}`;
        }

        // --- INVOICE ID GENERATOR ---
        async function generateInvoiceId(dateStr) {
            const [year, month, day] = dateStr.split('-');
            const prefix = `KPA-${year}${month}-`;

            const snapshot = await db.collection('klinikazam_appointments')
                .where('invoice_id', '>=', prefix)
                .where('invoice_id', '<', prefix + 'Z') 
                .orderBy('invoice_id', 'desc')
                .limit(1)
                .get();

            let nextNum = 1;
            if (!snapshot.empty) {
                const lastDoc = snapshot.docs[0];
                const lastInvId = lastDoc.data().invoice_id;
                const parts = lastInvId.split('-');
                const lastNum = parseInt(parts[2]);
                if (!isNaN(lastNum)) {
                    nextNum = lastNum + 1;
                }
            }
            const numStr = String(nextNum).padStart(3, '0');
            return `${prefix}${numStr}`;
        }

        // --- FIREBASE DATA FETCHING ---
        async function refreshData() {
            // 1. Fetch Patients
            const pSnap = await db.collection('klinikazam_patients').orderBy('name').get();
            patients = pSnap.docs.map(d => ({ id: d.id, ...d.data() }));

            // 2. Fetch Services
            const sSnap = await db.collection('klinikazam_services').get();
            services = sSnap.docs.map(d => ({ id: d.id, ...d.data() }));

            // 3. Fetch Staff
            const stSnap = await db.collection('klinikazam_staff').orderBy('name').get();
            staff = stSnap.docs.map(d => ({ id: d.id, ...d.data() }));

            // 4. Fetch Appointments
            const aSnap = await db.collection('klinikazam_appointments').orderBy('date', 'desc').get(); 
            appointments = aSnap.docs.map(d => ({ id: d.id, ...d.data() }));

            // 5. Fetch Slot Exceptions
            const eSnap = await db.collection('klinikazam_slots').get();
            slotExceptions = eSnap.docs.map(d => ({ id: d.id, ...d.data() }));

            // Re-render current view
            const currentViewId = document.querySelector('.view-section.active')?.id.replace('view-', '');
            
            if(currentViewId === 'dashboard') renderDashboard();
            if(currentViewId === 'patients') renderPatients();
            if(currentViewId === 'services') renderServices();
            if(currentViewId === 'staff') renderStaff();
            if(currentViewId === 'slots') renderSlots();
            if(currentViewId === 'billing') renderBilling();
            if(currentViewId === 'appointments') renderAppointments();
            if(currentViewId === 'booking') {
                resetBookingForm(); 
                renderCalendar(currentCalDate);
                initCustomPatientSearch(); 
            }
            if(currentViewId === 'cashbill') {
                if(!isCashbillCreateView) renderCashbillList();
                else {
                    initCashBillPatientSearch();
                    populateCashBillServices();
                }
            }

            populateServiceDropdowns();
            applyRoleBasedUI();
        }

        // --- AUTHENTICATION (UPDATED) ---
        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            let email = u;

            // If input doesn't contain '@', assume it's a Username
            if (!u.includes('@')) {
                const q = await db.collection('klinikazam_staff').where('username', '==', u).limit(1).get();
                if (q.empty) {
                    loginError.innerText = "User not found";
                    return;
                }
                email = q.docs[0].data().email;
            }

            try {
                await auth.signInWithEmailAndPassword(email, p);
                // Auth listener will handle the rest
                loginError.innerText = "";
            } catch (error) {
                console.error(error);
                if (error.code === 'auth/wrong-password') loginError.innerText = "Invalid password";
                else if (error.code === 'auth/user-not-found') loginError.innerText = "Email not registered";
                else loginError.innerText = "Login failed";
            }
        }

        function logout() {
            auth.signOut().then(() => {
                location.reload();
            });
        }

        // --- NAVIGATION & UI ---
        function navigateTo(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[onclick="navigateTo('${viewId}')"]`);
            if(navItem) navItem.classList.add('active');
            
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const activeSection = document.getElementById('view-' + viewId);
            activeSection.classList.add('active');
            
            const titles = { 
                'dashboard':'Dashboard', 'appointments':'Appointments', 'booking':'New Booking', 
                'cashbill':'Cash Bill', 'billing':'Reports', 'staff':'Staff Management', 
                'patients':'Patients', 'services':'Services', 'slots':'Slot Management', 
                'bill-detail':'Bill Details' 
            };
            document.getElementById('pageTitle').innerText = titles[viewId] || 'Clinic Portal';

            if(document.getElementById('sidebar').classList.contains('mobile-open')) toggleMobileMenu();

            showLoading(true);

            if(viewId === 'dashboard') renderDashboard();
            if(viewId === 'appointments') renderAppointments();
            if(viewId === 'billing') {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(),1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                document.getElementById('billing-start').value = getLocalDateStr(firstDay);
                document.getElementById('billing-end').value = getLocalDateStr(lastDay);
                renderBilling();
            }
            if(viewId === 'staff') renderStaff();
            if(viewId === 'patients') renderPatients();
            if(viewId === 'services') renderServices();
            if(viewId === 'slots') {
                document.getElementById('slotDate').value = minBookingDate; 
                renderSlots();
            }
            if(viewId === 'booking') {
                resetBookingForm();
                currentCalDate = new Date(minBookingDate);
                renderCalendar(currentCalDate);
                initCustomPatientSearch();
            }
            if(viewId === 'cashbill') {
                isCashbillCreateView = false;
                toggleCashbillCreate(false);
                renderCashbillList();
            }

            setTimeout(() => showLoading(false), 300);
        }

        function applyRoleBasedUI() {
            if(!currentUser) return;
            const isSuperAdmin = currentUser.role === 'SuperAdmin';
            const isAdmin = currentUser.role === 'Admin';
            const navStaff = document.getElementById('nav-staff');
            if(isSuperAdmin || isAdmin) navStaff.style.display = 'flex';
            else navStaff.style.display = 'none';
            
            if(document.getElementById('view-staff').classList.contains('active')) renderStaff(); 
        }

        function setupUserUI(user) {
            document.getElementById('userNameDisplay').innerText = user.name;
            document.getElementById('userRoleDisplay').innerText = user.role;
            document.getElementById('userAvatar').innerText = user.name.substring(0,2).toUpperCase();
            document.getElementById('profile-name').innerText = user.name;
            document.getElementById('profile-role').innerText = user.role;
            document.getElementById('profile-u').innerText = user.username;
            document.getElementById('profile-email').innerText = user.email || '-';
            document.getElementById('profile-id').innerText = user.id;
            document.getElementById('profile-avatar').innerText = user.name.substring(0,2).toUpperCase();
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            sidebar.classList.toggle('mobile-open');
            backdrop.classList.toggle('active');
        }

        function startLiveClock() {
            setInterval(() => {
                const now = new Date();
                let hours = now.getHours();
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; 
                document.getElementById('liveClock').innerText = `${hours}:${minutes}:${seconds} ${ampm}`;
                document.getElementById('liveDate').innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                document.getElementById('currentFullDate').innerText = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            }, 1000);
        }

        function resetInactivityTimer() {
            clearTimeout(window.inactivityTimer);
            window.inactivityTimer = setTimeout(() => logout(), 30 * 60 * 1000);
        }

        function getLocalDateStr(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(dateStr) {
            if(!dateStr) return '-';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        // --- PAGINATION HELPERS ---
        function getPaginatedData(array, viewKey) {
            const config = paginationConfig[viewKey] || { page: 1, limit: 10 };
            const start = (config.page - 1) * config.limit;
            const end = start + config.limit;
            return {
                data: array.slice(start, end),
                start: start,
                end: end,
                total: array.length,
                page: config.page,
                totalPages: Math.ceil(array.length / config.limit)
            };
        }

        function renderPaginationControls(viewKey, totalItems) {
            const container = document.getElementById(`pag-${viewKey}`);
            if(!container) return;

            const config = paginationConfig[viewKey];
            const totalPages = Math.ceil(totalItems / config.limit);
            
            // Don't render if 0 or 1 page (optional, but good UX)
            if(totalItems === 0) {
                container.innerHTML = '';
                return;
            }

            const start = ((config.page - 1) * config.limit) + 1;
            const end = Math.min(start + config.limit - 1, totalItems);

            container.innerHTML = `
                <div class="pagination-info">Showing ${start} to ${end} of ${totalItems} entries</div>
                <div class="pagination-controls">
                    <select class="rows-per-page-select" onchange="changePaginationLimit('${viewKey}', this.value)">
                        <option value="5" ${config.limit == 5 ? 'selected' : ''}>5 / page</option>
                        <option value="10" ${config.limit == 10 ? 'selected' : ''}>10 / page</option>
                        <option value="20" ${config.limit == 20 ? 'selected' : ''}>20 / page</option>
                        <option value="50" ${config.limit == 50 ? 'selected' : ''}>50 / page</option>
                    </select>
                    <button class="pagination-btn" onclick="changePaginationPage('${viewKey}', -1)" ${config.page === 1 ? 'disabled' : ''}><i class="fa-solid fa-chevron-left"></i></button>
                    <span style="font-size:0.85rem; font-weight:600; color:var(--text-main);">Page ${config.page} of ${totalPages}</span>
                    <button class="pagination-btn" onclick="changePaginationPage('${viewKey}', 1)" ${config.page === totalPages ? 'disabled' : ''}><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            `;
        }

        function changePaginationPage(viewKey, delta) {
            const config = paginationConfig[viewKey];
            const newPage = config.page + delta;
            if(newPage > 0) {
                config.page = newPage;
                // Trigger re-render of the specific view
                if(viewKey.includes('appointments')) renderAppointments();
                else if(viewKey === 'patients') renderPatients();
                else if(viewKey === 'staff') renderStaff();
                else if(viewKey === 'billing') renderBilling();
                else if(viewKey === 'cashbill') renderCashbillList();
            }
        }

        function changePaginationLimit(viewKey, limit) {
            paginationConfig[viewKey].limit = parseInt(limit);
            paginationConfig[viewKey].page = 1; // Reset to first page
            // Trigger re-render
            if(viewKey.includes('appointments')) renderAppointments();
            else if(viewKey === 'patients') renderPatients();
            else if(viewKey === 'staff') renderStaff();
            else if(viewKey === 'billing') renderBilling();
            else if(viewKey === 'cashbill') renderCashbillList();
        }

        // --- SORTING HANDLER ---
        function handleSort(type, value) {
            sortState[type] = value;
            if(type === 'appointments' || type === 'history') renderAppointments();
            if(type === 'cashbill') renderCashbillList();
            if(type === 'billing') renderBilling();
        }

        // --- DASHBOARD LOGIC ---
        function renderDashboard() {
            const todaysAppts = appointments.filter(a => a.date === todayStr && a.status !== 'Cancelled');
            document.getElementById('d-stat-today').innerText = todaysAppts.length;
            document.getElementById('d-stat-history').innerText = patients.length;
            
            const todaySales = calculateTotalForDate(todayStr);
            document.getElementById('d-stat-sales').innerText = 'RM ' + todaySales.toLocaleString();

            const tbody = document.querySelector('#dashboard-table tbody');
            tbody.innerHTML = '';
            todaysAppts.sort((a,b) => a.time.localeCompare(b.time)).forEach(a => {
                const p = patients.find(pt => pt.id === a.patient_id);
                const pName = p ? p.name : 'Unknown';
                const sId = a.items && a.items[0] ? a.items[0].id : null;
                const sName = sId ? (services.find(s => s.id === sId)?.name || "Service") : "Unknown";
                
                tbody.innerHTML += `
                <tr>
                    <td style="font-weight:700;">${a.time}</td>
                    <td>${pName}</td>
                    <td>${sName}</td>
                    <td><span class="badge badge-${a.status.toLowerCase()}">${a.status}</span></td>
                    <td>
                        ${a.status !== 'Completed' ? `<a href="#" class="btn-sm btn-wa" onclick="sendWhatsapp('${pName}', '${a.date}', '${a.time}', '${p ? p.phone : ''}')"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
                        <button class="btn-sm" onclick="openEditAppt('${a.id}')"><i class="fa-solid fa-pen"></i></button> 
                        ${a.status === 'Completed' ? `<button class="btn-sm btn-bill" onclick="viewBillDetail('${a.id}')"><i class="fa-solid fa-file-invoice"></i></button>` : `<button class="btn-sm btn-bill" onclick="createCashbill('${a.id}')"><i class="fa-solid fa-file-invoice-dollar"></i> Bill</button>`}
                        
                        ${currentUser.role === 'SuperAdmin' && a.id !== currentUser.id ? `<button class="btn-sm btn-delete" onclick="requestDelete('appointment', '${a.id}')"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </td>
                </tr>`;
            });
        }

        function calculateTotalForDate(dateStr) {
            let total = 0;
            const dayAppts = appointments.filter(a => a.date === dateStr && a.status === 'Completed');
            dayAppts.forEach(a => {
                if(a.items) {
                    a.items.forEach(i => { total += (i.price * i.qty); });
                }
            });
            return total;
        }

        // --- APPOINTMENTS LOGIC ---
        function renderAppointments() {
            // 1. UPCOMING SCHEDULE
            const queryAppt = document.querySelector('#view-appointments .search-input')?.value.toLowerCase() || '';
            const sortVal = sortState.appointments;
            
            let schedule = appointments.filter(a => a.status !== 'Cancelled' && a.status !== 'Completed');
            // Sorting
            schedule.sort((a,b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return sortVal === 'desc' ? dateB - dateA : dateA - dateB;
            });

            let filteredSchedule = schedule;
            if(queryAppt) {
                filteredSchedule = schedule.filter(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const pName = p ? p.name.toLowerCase() : '';
                    const sName = a.items ? a.items.map(i => services.find(s=>s.id===i.id)?.name).join(', ').toLowerCase() : '';
                    return pName.includes(queryAppt) || sName.includes(queryAppt) || a.date.includes(queryAppt);
                });
            }

            const pagedUpcoming = getPaginatedData(filteredSchedule, 'appointments-upcoming');
            const tBody = document.querySelector('#today-table tbody');
            tBody.innerHTML = '';
            
            pagedUpcoming.data.forEach(a => {
                const p = patients.find(pt => pt.id === a.patient_id);
                const pName = p ? p.name : 'Unknown';
                const pPhone = p ? p.phone : '-';
                const sName = a.items ? a.items.map(i => services.find(s=>s.id===i.id)?.name).join(', ') : "Unknown";
                
                tBody.innerHTML += `
                <tr>
                    <td>${formatDateDisplay(a.date)}</td>
                    <td style="font-weight:700; color:var(--primary);">${a.time}</td>
                    <td>${pName}</td>
                    <td>${pPhone}</td>
                    <td>${sName}</td>
                    <td><span class="badge badge-${a.status.toLowerCase()}">${a.status}</span></td>
                    <td>
                        <a href="#" class="btn-sm btn-wa" onclick="sendWhatsapp('${pName}', '${a.date}', '${a.time}', '${pPhone}')"><i class="fa-brands fa-whatsapp"></i></a>
                        <button class="btn-sm" onclick="openEditAppt('${a.id}')"><i class="fa-solid fa-pen"></i></button> 
                        <button class="btn-sm btn-bill" onclick="createCashbill('${a.id}')"><i class="fa-solid fa-file-invoice-dollar"></i> Bill</button>
                        
                        ${currentUser.role !== 'Staff' ? `<button class="btn-sm btn-delete" onclick="openCancelConfirm('${a.id}')"><i class="fa-solid fa-ban"></i> Cancel</button>` : ''}
                        
                        ${(currentUser.role === 'SuperAdmin' && a.id !== currentUser.id) ? `<button class="btn-sm btn-delete" onclick="requestDelete('appointment', '${a.id}')"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </td>
                </tr>`;
            });
            renderPaginationControls('appointments-upcoming', filteredSchedule.length);

            // 2. HISTORY
            let history = appointments.filter(a => a.status === 'Completed');
            const histSort = sortState.history;
            history.sort((a,b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return histSort === 'desc' ? dateB - dateA : dateA - dateB;
            });

            // Filter history
            const queryHist = document.querySelectorAll('#view-appointments .search-input')[1]?.value.toLowerCase() || '';
            let filteredHist = history;
            if(queryHist) {
                filteredHist = history.filter(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const pName = p ? p.name.toLowerCase() : '';
                    const sName = a.items ? a.items.map(i => services.find(s=>s.id===i.id)?.name).join(', ').toLowerCase() : '';
                    return pName.includes(queryHist) || sName.includes(queryHist);
                });
            }

            const pagedHist = getPaginatedData(filteredHist, 'appointments-history');
            const hBody = document.querySelector('#history-table tbody');
            hBody.innerHTML = '';
            pagedHist.data.forEach(a => {
                const p = patients.find(pt => pt.id === a.patient_id);
                const pName = p ? p.name : 'Unknown';
                const sName = a.items ? a.items.map(i => services.find(s=>s.id===i.id)?.name).join(', ') : "Unknown";
                const invDisplay = a.invoice_id || `INV-${a.id}`;
                hBody.innerHTML += `
                <tr>
                    <td>${formatDateDisplay(a.date)}</td>
                    <td style="font-weight:600;">${a.time}</td>
                    <td>${pName}</td>
                    <td>${sName}</td>
                    <td><span class="badge badge-completed">Completed</span></td>
                    <td>
                        <span class="invoice-link" onclick="viewBillDetail('${a.id}')">[${invDisplay}]</span>
                    </td>
                </tr>`;
            });
            renderPaginationControls('appointments-history', filteredHist.length);
            
            // 3. CANCELLED
            let cancelled = appointments.filter(a => a.status === 'Cancelled');
            cancelled.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            // Filter cancelled
            const queryCancel = document.querySelectorAll('#view-appointments .search-input')[2]?.value.toLowerCase() || '';
            let filteredCancel = cancelled;
            if(queryCancel) {
                filteredCancel = cancelled.filter(a => {
                    const p = patients.find(p => p.id === a.patient_id);
                    const pName = p ? p.name.toLowerCase() : '';
                    const sName = a.items ? a.items.map(i => services.find(s=>s.id===i.id)?.name).join(', ').toLowerCase() : "";
                    return pName.includes(queryCancel) || sName.includes(queryCancel);
                });
            }

            const pagedCancel = getPaginatedData(filteredCancel, 'appointments-cancelled');
            const cBody = document.querySelector('#cancelled-table tbody');
            cBody.innerHTML = '';
            pagedCancel.data.forEach(a => {
                const p = patients.find(p => p.id === a.patient_id);
                const pName = p ? p.name : 'Unknown';
                const sName = a.items ? a.items.map(i => services.find(s=>s.id===i.id)?.name).join(', ') : "Unknown";
                
                const delBtn = (currentUser.role === 'SuperAdmin' && a.id !== currentUser.id) 
                    ? `<button class="btn-sm btn-delete" onclick="requestDelete('appointment', '${a.id}')"><i class="fa-solid fa-trash"></i></button>` : '';

                cBody.innerHTML += `<tr><td>${formatDateDisplay(a.date)}</td><td style="font-weight:600; color:var(--danger);">${a.time}</td><td>${pName}</td><td>${sName}</td><td>${delBtn}</td></tr>`;
            });
            renderPaginationControls('appointments-cancelled', filteredCancel.length);
        }

        // --- CASH BILL LOGIC ---
        function toggleCashbillCreate(showCreate) {
            isCashbillCreateView = showCreate;
            document.getElementById('cashbill-list-view').style.display = showCreate ? 'none' : 'block';
            document.getElementById('cashbill-create-view').style.display = showCreate ? 'block' : 'none';
            
            if(showCreate) {
                resetCashBill();
                initCashBillPatientSearch();
                populateCashBillServices();
            } else {
                renderCashbillList();
            }
        }

        function renderCashbillList() {
            const query = document.querySelector('#view-cashbill .search-input')?.value.toLowerCase() || '';
            const sortVal = sortState.cashbill;
            
            let list = appointments.filter(a => a.status === 'Completed');
            list.sort((a,b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return sortVal === 'desc' ? dateB - dateA : dateA - dateB;
            });

            if(query) {
                list = list.filter(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const pName = p ? p.name.toLowerCase() : '';
                    const inv = (a.invoice_id || '').toLowerCase();
                    return pName.includes(query) || inv.includes(query);
                });
            }

            const pagedData = getPaginatedData(list, 'cashbill');
            const tbody = document.querySelector('#cashbill-table tbody');
            tbody.innerHTML = '';
            if(pagedData.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No cashbills found.</td></tr>';
            } else {
                pagedData.data.forEach(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const total = a.items ? a.items.reduce((sum, i) => sum + (i.price*i.qty), 0) : 0;
                    tbody.innerHTML += `
                    <tr>
                        <td><span class="invoice-link" onclick="viewBillDetail('${a.id}')">${a.invoice_id || 'NO INV'}</span></td>
                        <td>${formatDateDisplay(a.date)}</td>
                        <td>${p ? p.name : 'Unknown'}</td>
                        <td style="font-weight:700;">RM ${total.toFixed(2)}</td>
                        <td>
                            <button class="btn-sm btn-bill" onclick="viewBillDetail('${a.id}')"><i class="fa-solid fa-eye"></i> View</button>
                            <button class="btn-sm btn-wa" onclick="sendWhatsapp('${p?p.name:''}', '${a.date}', '${a.time}', '${p?p.phone:''}')"><i class="fa-brands fa-whatsapp"></i></button>
                        </td>
                    </tr>`;
                });
            }
            renderPaginationControls('cashbill', list.length);
        }

        function resetCashBill() {
            cashBillPatientId = null;
            currentCashBillItems = [];
            document.getElementById('cb-pat-search').value = '';
            document.getElementById('cb-pat-id').value = '';
            document.getElementById('cb-pat-details').style.display = 'none';
            document.getElementById('cb-items-table').querySelector('tbody').innerHTML = '';
            document.getElementById('cb-total-display').innerText = '0.00';
            document.getElementById('cb-amount-received').value = '';
            document.getElementById('payment-inputs').style.display = 'none';
            document.getElementById('balance-display').style.display = 'none';
            document.getElementById('cb-save-btn').disabled = true;
            setPaymentType('CASH');
        }

        function initCashBillPatientSearch() {
            const searchInput = document.getElementById('cb-pat-search');
            const list = document.getElementById('cb-pat-list');
            const clearBtn = document.getElementById('clear-cb-pat');

            const sortedPatients = [...patients].sort((a, b) => a.name.localeCompare(b.name));

            function renderList(filterText = '') {
                list.innerHTML = '';
                const lowerFilter = filterText.toLowerCase();
                const filtered = sortedPatients.filter(p => 
                    p.name.toLowerCase().includes(lowerFilter) || 
                    (p.phone && p.phone.includes(lowerFilter))
                );
                
                if (filtered.length === 0) {
                    list.innerHTML = '<li class="no-option">No patients found</li>';
                } else {
                    filtered.forEach(p => {
                        const li = document.createElement('li');
                        li.innerHTML = `<div>${p.name}</div><span class="sub-text">${p.phone || 'No Phone'}</span>`;
                        li.onclick = () => selectCashBillPatient(p);
                        list.appendChild(li);
                    });
                }
            }

            searchInput.addEventListener('focus', () => {
                renderList(searchInput.value);
                list.classList.add('show');
            });

            searchInput.addEventListener('input', (e) => {
                renderList(e.target.value);
                cashBillPatientId = null; 
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-select-wrapper')) {
                    list.classList.remove('show');
                }
            });

            clearBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                resetCashBill();
                searchInput.focus();
            });
        }

        function selectCashBillPatient(p) {
            cashBillPatientId = p.id;
            document.getElementById('cb-pat-search').value = p.name; 
            document.getElementById('cb-pat-id').value = p.id;
            document.getElementById('cb-pat-list').classList.remove('show'); 
            document.getElementById('clear-cb-pat').style.display = 'block';
            
            document.getElementById('cb-pat-details').style.display = 'block';
            document.getElementById('cb-p-name').innerText = p.name;
            document.getElementById('cb-p-ic').innerText = p.ic || '-';
            document.getElementById('cb-p-phone').innerText = p.phone;
        }

        function clearCashBillPatient() {
            document.getElementById('cb-pat-search').value = '';
            document.getElementById('cb-pat-id').value = '';
            document.getElementById('cb-pat-details').style.display = 'none';
            document.getElementById('clear-cb-pat').style.display = 'none';
            cashBillPatientId = null;
        }

        function populateCashBillServices() {
            const select = document.getElementById('cb-service-select');
            select.innerHTML = '<option value="" disabled selected>-- Select Service to Add --</option>';
            services.forEach(s => select.innerHTML += `<option value="${s.id}" data-price="${s.price}">${s.name} - RM ${s.price}</option>`);
        }

        function addToCashBill() {
            const select = document.getElementById('cb-service-select');
            const sId = select.value;
            if(!sId || !cashBillPatientId) {
                showToast("Select patient first");
                return;
            }

            const s = services.find(x => x.id == sId);
            currentCashBillItems.push({ id: sId, qty: 1, price: s.price, name: s.name });
            renderCashBillItems();
            select.value = ""; 
        }

        function renderCashBillItems() {
            const tbody = document.querySelector('#cb-items-table tbody');
            tbody.innerHTML = '';
            let total = 0;
            currentCashBillItems.forEach((item, idx) => {
                const lineTotal = item.price * item.qty;
                total += lineTotal;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.name} <small style="color:var(--text-light)">x${item.qty}</small></td>
                        <td>RM ${lineTotal.toFixed(2)}</td>
                        <td><button class="btn-sm btn-delete" onclick="removeCashBillItem(${idx})"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>
                `;
            });
            document.getElementById('cb-total-display').innerText = total.toFixed(2);
            document.getElementById('cb-save-btn').disabled = currentCashBillItems.length === 0;
        }

        function removeCashBillItem(idx) {
            currentCashBillItems.splice(idx, 1);
            renderCashBillItems();
        }

        function setPaymentType(type) {
            cashBillPaymentType = type;
            document.getElementById('pay-cash').classList.toggle('active', type === 'CASH');
            document.getElementById('pay-qr').classList.toggle('active', type === 'QR');

            const inputs = document.getElementById('payment-inputs');
            const balDisplay = document.getElementById('balance-display');
            
            if(type === 'CASH') {
                inputs.style.display = 'block';
                calculateBalance();
            } else {
                inputs.style.display = 'none';
                balDisplay.style.display = 'none';
            }
        }

        function calculateBalance() {
            if(cashBillPaymentType !== 'CASH') return;
            const total = parseFloat(document.getElementById('cb-total-display').innerText);
            const received = parseFloat(document.getElementById('cb-amount-received').value) || 0;
            const balance = received - total;

            const balDisplay = document.getElementById('balance-display');
            if(received > 0) {
                balDisplay.style.display = 'block';
                balDisplay.innerText = `Change: RM ${balance.toFixed(2)}`;
            } else {
                balDisplay.style.display = 'none';
            }
        }

        async function saveCashBill() {
            if(!cashBillPatientId) { showToast("Please select a patient"); return; }
            if(currentCashBillItems.length === 0) { showToast("Please add services"); return; }
            
            if(cashBillPaymentType === 'CASH') {
                 const total = parseFloat(document.getElementById('cb-total-display').innerText);
                 const received = parseFloat(document.getElementById('cb-amount-received').value) || 0;
                 if(received < total) {
                     showToast("Insufficient amount received");
                     return;
                 }
            }

            const invId = await generateInvoiceId(todayStr);
            
            const newAppt = {
                id: await generateSmartId('klinikazam_appointments', 'APT'),
                patient_id: cashBillPatientId,
                date: todayStr,
                time: "WALK-IN",
                items: currentCashBillItems,
                status: 'Completed',
                payment_method: cashBillPaymentType,
                invoice_id: invId
            };

            try {
                showLoading(true);
                await db.collection('klinikazam_appointments').add(newAppt);
                showToast("Bill Generated Successfully");
                toggleCashbillCreate(false); 
                await refreshData(); 
            } catch(e) {
                showToast("Error saving bill");
                console.error(e);
            } finally {
                showLoading(false);
            }
        }

        // --- BILLING LOGIC ---
        function renderBilling() {
            const start = document.getElementById('billing-start').value;
            const end = document.getElementById('billing-end').value;
            const query = document.querySelector('#view-billing .search-input')?.value.toLowerCase() || '';
            const sortVal = sortState.billing;

            const tbody = document.querySelector('#billing-table tbody');
            const totalDisplay = document.getElementById('billing-total-amount');

            if(!start || !end) return;

            let filteredAppts = appointments.filter(a => 
                a.status === 'Completed' && 
                a.date >= start && 
                a.date <= end
            );

            filteredAppts.sort((a,b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return sortVal === 'desc' ? dateB - dateA : dateA - dateB;
            });

            if(query) {
                filteredAppts = filteredAppts.filter(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const pName = p ? p.name.toLowerCase() : '';
                    const invId = a.invoice_id ? a.invoice_id.toLowerCase() : `inv-${a.id}`;
                    return pName.includes(query) || invId.includes(query);
                });
            }

            // Pagination for Billing
            const pagedData = getPaginatedData(filteredAppts, 'billing');
            
            let total = 0;
            filteredAppts.forEach(a => {
                if(a.items) {
                    a.items.forEach(i => { total += (i.price * i.qty); });
                }
            });

            totalDisplay.innerText = total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            tbody.innerHTML = '';
            if(pagedData.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">No bills found in this period.</td></tr>';
            } else {
                pagedData.data.forEach(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const pName = p ? p.name : 'Unknown';
                    const pPhone = p ? p.phone : '-';
                    const displayId = a.invoice_id || `INV-${a.id}`;
                    
                    let itemsStr = a.items.map(i => {
                        const s = services.find(sv => sv.id === i.id);
                        return `${s ? s.name : 'Unknown'} (x${i.qty})`;
                    }).join(', ');
                    
                    let apptTotal = a.items.reduce((sum, i) => sum + (i.price * i.qty), 0);
                    tbody.innerHTML += `
                    <tr>
                        <td><span class="invoice-link" onclick="viewBillDetail('${a.id}')">${displayId}</span></td>
                        <td>${formatDateDisplay(a.date)}</td>
                        <td>${pName}</td>
                        <td>${pPhone}</td>
                        <td><small>${itemsStr}</small></td>
                        <td style="font-weight:700; color:var(--primary);">RM ${apptTotal}</td>
                        <td><span class="badge badge-completed">Billed</span></td>
                        <td>
                            <button class="btn-sm btn-bill" onclick="viewBillDetail('${a.id}')"><i class="fa-solid fa-eye"></i> View</button>
                        </td>
                    </tr>`;
                });
            }
            renderPaginationControls('billing', filteredAppts.length);
        }

        function exportBillingData() {
            const start = document.getElementById('billing-start').value;
            const end = document.getElementById('billing-end').value;
            
            let data = appointments.filter(a => 
                a.status === 'Completed' && 
                a.date >= start && 
                a.date <= end
            )
            .sort((a,b) => new Date(b.date) - new Date(a.date)) 
            .map(a => {
                const p = patients.find(pt => pt.id === a.patient_id);
                return {
                    Date: a.date,
                    Time: a.time,
                    Patient: p ? p.name : 'Unknown',
                    Phone: p ? p.phone : '-',
                    Invoice: a.invoice_id || '-',
                    Total: a.items.reduce((sum, i) => sum + (i.price * i.qty), 0)
                };
            });

            if(data.length === 0) {
                showToast("No data to export.");
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," 
                + Object.keys(data[0]).join(",") + "\n" 
                + data.map(e => Object.values(e).join(",")).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `report_${start}_to_${end}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Report Downloaded");
        }

        // --- INVOICE VIEW (UPDATED LAYOUT) ---
        async function viewBillDetail(id) {
            const a = appointments.find(x => x.id === id);
            if(!a) return;

            currentBillAppt = a;
            const p = patients.find(pt => pt.id === a.patient_id);

            if (!a.invoice_id && a.status === 'Completed') {
                const newId = await generateInvoiceId(a.date);
                await db.collection('klinikazam_appointments').doc(id).update({ invoice_id: newId });
                a.invoice_id = newId;
                showToast("Invoice ID Generated");
            }

            // Populate New Invoice Layout
            document.getElementById('inv-no').innerText = a.invoice_id || 'Pending Generation';
            document.getElementById('inv-date').innerText = formatDateDisplay(a.date);
            
            document.getElementById('inv-p-name').innerText = p ? p.name : 'Unknown';
            document.getElementById('inv-p-ic').innerText = p ? (p.ic || '-') : '-';
            document.getElementById('inv-p-phone').innerText = p ? (p.phone || '-') : '-';
            
            document.getElementById('inv-payment').innerText = a.payment_method || 'CASH';

            const tbody = document.getElementById('inv-items-body');
            tbody.innerHTML = '';
            let total = 0;

            if(a.items) {
                a.items.forEach((item, index) => {
                    const s = services.find(s => s.id === item.id);
                    const name = s ? s.name : 'Unknown Service';
                    const lineTotal = item.price * item.qty;
                    total += lineTotal;

                    tbody.innerHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${name}</td>
                            <td class="right">${item.qty}</td>
                            <td class="right">${item.price.toFixed(2)}</td>
                            <td class="right">${lineTotal.toFixed(2)}</td>
                        </tr>
                    `;
                });
            }

            document.getElementById('inv-subtotal').innerText = `RM ${total.toFixed(2)}`;
            document.getElementById('inv-total').innerText = `RM ${total.toFixed(2)}`;

            navigateTo('bill-detail');
        }

        function openEditInvoiceFromPage() {
            openInvoice(currentBillAppt.id);
        }

        // --- CALENDAR & BOOKING (UPDATED DATE RULE) ---
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('cal-month-year').innerText = `${monthNames[month]} ${year}`;
            const grid = document.getElementById('calendar-days');
            grid.innerHTML = '';
            for(let i=0; i<startingDay; i++) {
                const el = document.createElement('div');
                el.className = 'cal-day empty';
                grid.appendChild(el);
            }
            for(let i=1; i<=daysInMonth; i++) {
                const dayDate = new Date(year, month, i);
                const dateStr = getLocalDateStr(dayDate);
                const el = document.createElement('div');
                let classes = 'cal-day';
                
                // Check if Sunday (0)
                const isSunday = dayDate.getDay() === 0;

                if(dateStr < minBookingDate) classes += ' disabled';
                
                if(dateStr === getLocalDateStr(new Date())) classes += ' today'; 
                if(selectedBookingDate === dateStr) classes += ' active';
                el.className = classes;
                el.innerText = i;
                
                const isClosed = slotExceptions.some(e => e.date === dateStr && e.type === 'closed');
                const apptCount = appointments.filter(a => a.date === dateStr && a.status !== 'Cancelled').length;
                const isFull = apptCount >= defaultSlots.length;

                // Disable if Sunday, Closed, Full, or Past date
                if(isClosed || isFull || dateStr < minBookingDate || isSunday) classes += ' disabled';
                el.className = classes;
                
                if(!classes.includes('disabled')) {
                    el.onclick = () => selectDate(dateStr);
                } else if (dateStr === todayStr) {
                    el.onclick = () => showToast("Please Booking at least one day earlier.");
                    el.title = "Booking not allowed on the same day";
                } else if (isSunday) {
                    el.onclick = () => showToast("Clinic is closed on Sundays.");
                    el.title = "Clinic Closed";
                }

                grid.appendChild(el);
            }
        }

        function changeMonth(delta) {
            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            currentCalDate = new Date(year, month + delta,1);
            renderCalendar(currentCalDate);
        }

        async function selectDate(dateStr) {
            if(dateStr < minBookingDate) {
                showToast("Please Booking at least one day earlier.");
                return;
            }

            selectedBookingDate = dateStr;
            selectedBookingTime = null;
            renderCalendar(currentCalDate);
            await renderBookingSlots(dateStr);
            const displayDate = new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('slot-date-display').innerText = displayDate;
            document.getElementById('slot-sub-display').innerText = "Select a time slot";
            document.getElementById('summary-date').innerText = formatDateDisplay(dateStr);
            checkBookingFormComplete();
        }

        async function renderBookingSlots(dateStr) {
            const list = document.getElementById('booking-slots-list');
            list.innerHTML = '';
            
            const bookedTimes = appointments.filter(a => a.date === dateStr && a.status !== 'Cancelled' && a.status !== 'Completed').map(a => a.time);
            const blocked = slotExceptions.filter(e => e.date === dateStr && e.type === 'blocked').map(e => e.time);

            defaultSlots.forEach(time => {
                const isBooked = bookedTimes.includes(time);
                const isBlocked = blocked.includes(time);
                const btn = document.createElement('div');
                let className = 'slot-item';
                if(isBooked) {
                    className += ' booked';
                    btn.innerHTML = `${time} <small>Booked</small>`;
                } else if (isBlocked) {
                    className += ' blocked';
                    btn.innerHTML = `${time} <small>Break</small>`;
                } else {
                    btn.innerHTML = time;
                    btn.onclick = () => selectTime(time, btn);
                }
                btn.className = className;
                list.appendChild(btn);
            });
        }

        function selectTime(time, el) {
            selectedBookingTime = time;
            document.querySelectorAll('.slot-item').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('slot-sub-display').innerText = `Selected: ${time}`;
            document.getElementById('summary-time').innerText = time;
            checkBookingFormComplete();
        }

        // --- CUSTOM PATIENT SEARCH DROPDOWN (Booking) ---
        function initCustomPatientSearch() {
            const searchInput = document.getElementById('bk-pat-search');
            const list = document.getElementById('bk-pat-list');
            const clearBtn = document.getElementById('clear-pat-search');
            
            const sortedPatients = [...patients].sort((a, b) => a.name.localeCompare(b.name));

            function renderList(filterText = '') {
                list.innerHTML = '';
                const lowerFilter = filterText.toLowerCase();
                const filtered = sortedPatients.filter(p => 
                    p.name.toLowerCase().includes(lowerFilter) || 
                    (p.phone && p.phone.includes(lowerFilter))
                );
                
                if (filtered.length === 0) {
                    list.innerHTML = '<li class="no-option">No patients found</li>';
                } else {
                    filtered.forEach(p => {
                        const li = document.createElement('li');
                        li.innerHTML = `<div>${p.name}</div><span class="sub-text">${p.phone || 'No Phone'}</span>`;
                        li.onclick = () => selectPatient(p);
                        list.appendChild(li);
                    });
                }
            }

            searchInput.addEventListener('focus', () => {
                renderList(searchInput.value);
                list.classList.add('show');
            });

            searchInput.addEventListener('input', (e) => {
                renderList(e.target.value);
                document.getElementById('bk-pat-select').value = ''; 
                document.getElementById('bk-review-phone').value = '';
                document.getElementById('bk-review-ic').value = '';
                clearBtn.style.display = 'block';
                checkBookingFormComplete();
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-select-wrapper')) {
                    list.classList.remove('show');
                }
            });

            clearBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                clearPatientSelection();
                searchInput.focus();
            });
        }

        function selectPatient(p) {
            const searchInput = document.getElementById('bk-pat-search');
            const clearBtn = document.getElementById('clear-pat-search');
            
            searchInput.value = p.name; 
            document.getElementById('bk-pat-select').value = p.id; 
            document.getElementById('bk-review-phone').value = p.phone;
            document.getElementById('bk-review-ic').value = p.ic || '-';
            document.getElementById('bk-pat-list').classList.remove('show'); 
            
            clearBtn.style.display = 'block';
            
            checkBookingFormComplete();
        }

        function clearPatientSelection() {
            const searchInput = document.getElementById('bk-pat-search');
            const clearBtn = document.getElementById('clear-pat-search');
            
            searchInput.value = '';
            document.getElementById('bk-pat-select').value = ''; 
            document.getElementById('bk-review-phone').value = '';
            document.getElementById('bk-review-ic').value = '';
            
            clearBtn.style.display = 'none'; 
            checkBookingFormComplete();
        }

        // --- SAVING BOOKING ---
        async function saveNewBooking(e) {
            e.preventDefault();
            const isNew = document.querySelector('input[name="patType"]:checked').value === 'new';
            let patientId;

            if(!selectedBookingDate || !selectedBookingTime) {
                showToast("Please select Date and Time.");
                return;
            }
            const sId = document.getElementById('bk-service').value;
            const srv = services.find(s=>s.id == sId);
            const sPrice = srv ? srv.price : 0;

            if(isNew) {
                const name = document.getElementById('bk-name').value;
                const phone = document.getElementById('bk-phone').value;
                const ic = document.getElementById('bk-ic').value;

                let existing = patients.find(p => p.phone === phone);
                if(!existing) {
                    const smartId = await generateSmartId('klinikazam_patients', 'PAT');
                    const newPat = { id: smartId, name, phone, ic: ic || '-' };
                    await db.collection('klinikazam_patients').doc(smartId).set(newPat);
                    patientId = smartId;
                } else {
                    showToast("Patient exists. Using existing ID.");
                    patientId = existing.id;
                }
            } else {
                const pidRaw = document.getElementById('bk-pat-select').value;
                if (!pidRaw) { showToast("Please select a valid patient from list."); return; }
                patientId = pidRaw;
            }

            if(patientId) {
                showLoading(true);
                const smartId = await generateSmartId('klinikazam_appointments', 'APT');
                const newAppt = {
                    id: smartId,
                    patient_id: patientId,
                    date: selectedBookingDate,
                    time: selectedBookingTime,
                    items: [{ id: parseInt(sId), qty:1, price: sPrice }],
                    status: 'Pending',
                    payment_method: 'CASH',
                    invoice_id: null
                };

                await db.collection('klinikazam_appointments').doc(smartId).set(newAppt);
                showToast("Booking Confirmed");
                await refreshData(); 
                renderAppointments();
                renderDashboard();
                resetBookingForm();
                showLoading(false);
            }
        }

        function resetBookingForm() {
            selectedBookingDate = null; selectedBookingTime = null; currentCalDate = new Date(minBookingDate);
            document.getElementById('newBookingForm').reset();
            document.querySelector('input[name="patType"][value="new"]').checked = true;
            togglePatientType();
            clearPatientSelection();
            document.getElementById('confirm-booking-btn').disabled = true;
            document.getElementById('slot-date-display').innerText = "Select a Date";
            document.getElementById('booking-slots-list').innerHTML = `<div style="text-align:center; color:var(--text-light); margin-top:30px; font-size:0.85rem;"><i class="fa-regular fa-calendar" style="font-size:1.5rem; margin-bottom:8px; opacity:0.3;"></i><br>Select date from calendar</div>`;
            document.getElementById('summary-date').innerText = "-"; document.getElementById('summary-time').innerText = "-";
            renderCalendar(currentCalDate);
            initCustomPatientSearch(); 
        }

        function togglePatientType() {
            const isNew = document.querySelector('input[name="patType"]:checked').value === 'new';
            document.getElementById('new-pat-inputs').style.display = isNew ? 'block' : 'none';
            document.getElementById('old-pat-inputs').style.display = isNew ? 'none' : 'block';
            checkBookingFormComplete();
        }

        function checkBookingFormComplete() {
            const btn = document.getElementById('confirm-booking-btn');
            const service = document.getElementById('bk-service').value;
            if (!selectedBookingDate || !selectedBookingTime || !service) { btn.disabled = true; return; }

            const isNew = document.querySelector('input[name="patType"]:checked').value === 'new';
            let isPatientValid = false;
            if (isNew) {
                const name = document.getElementById('bk-name').value;
                const phone = document.getElementById('bk-phone').value;
                isPatientValid = (name.length > 0 && phone.length > 0);
            } else {
                const pid = document.getElementById('bk-pat-select').value;
                isPatientValid = (pid !== "" && pid !== null && pid !== "undefined");
            }
            btn.disabled = !isPatientValid;
        }

        // --- EDITING APPOINTMENTS ---
        async function openEditAppt(id) {
            const a = appointments.find(x => x.id === id);
            document.getElementById('edit-appt-id').value = id;
            document.getElementById('edit-appt-date').value = a.date;
            await updateEditTimeOptions();
            const srvSelect = document.getElementById('edit-appt-service');
            srvSelect.innerHTML = '';
            services.forEach(s => srvSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            if(a.items && a.items[0]) srvSelect.value = a.items[0].id;
            showModal('editApptModal');
        }

        async function updateEditTimeOptions() {
            const dateVal = document.getElementById('edit-appt-date').value;
            const timeSelect = document.getElementById('edit-appt-time');
            if(!dateVal || dateVal < minBookingDate) {
                timeSelect.innerHTML = '<option value="">Select Valid Future Date</option>'; timeSelect.disabled = true; return;
            }
            timeSelect.disabled = false;
            timeSelect.innerHTML = '<option value="">Select Time</option>';
            
            const bookedTimes = appointments.filter(a => a.date === dateVal && a.status !== 'Cancelled').map(a => a.time);
            const blockedTimes = slotExceptions.filter(e => e.date === dateVal && e.type === 'blocked').map(e => e.time);
            const available = defaultSlots.filter(t => !bookedTimes.includes(t) && !blockedTimes.includes(t));

            if(available.length === 0) {
                const opt = document.createElement('option'); opt.text = "No slots available"; opt.disabled = true; timeSelect.add(opt); timeSelect.disabled = true; 
            } else {
                available.forEach(t => {
                    const opt = document.createElement('option'); opt.value = t; opt.text = t; timeSelect.add(opt);
                });
            }
        }

        async function saveApptEdit() {
            const id = document.getElementById('edit-appt-id').value; 
            const dateVal = document.getElementById('edit-appt-date').value;
            const timeVal = document.getElementById('edit-appt-time').value;
            
            if(dateVal < minBookingDate) { showToast("Cannot book today or past dates."); return; }

            const conflict = appointments.find(a => a.date === dateVal && a.time === timeVal && a.status !== 'Cancelled' && a.status !== 'Completed' && a.id !== id);
            if(conflict) { showToast("Time slot conflict."); return; }

            const sId = parseInt(document.getElementById('edit-appt-service').value);
            const sPrice = services.find(s=>s.id == sId).price;
            
            await db.collection('klinikazam_appointments').doc(id).update({
                date: dateVal, time: timeVal, items: [{id: sId, qty:1, price: sPrice}]
            });

            await refreshData();
            renderAppointments();
            renderDashboard();
            closeModal('editApptModal');
            showToast("Updated");
        }

        // --- INVOICE EDITING ---
        let invoiceItems = [];
        function openInvoice(id) {
            const a = appointments.find(x => x.id === id);
            const p = patients.find(pt => pt.id === a.patient_id);
            currentBillAppt = a;
            document.getElementById('bill-p-name').innerText = p ? p.name : 'Unknown';
            document.getElementById('bill-date').innerText = formatDateDisplay(a.date);
            document.getElementById('bill-phone').innerText = p ? p.phone : '-';
            document.getElementById('bill-payment-method').value = a.payment_method || 'CASH';
            
            if(a.items && a.items.length >0) {
                invoiceItems = JSON.parse(JSON.stringify(a.items));
            } else {
                invoiceItems = [{ id: services[0].id, qty:1, price: services[0].price }];
            }
            renderInvoiceRows();
            showModal('invoiceModal');
        }

        function addInvoiceItem() { invoiceItems.push({ id: services[0].id, qty:1, price: services[0].price }); renderInvoiceRows(); }
        function removeInvoiceItem(idx) { invoiceItems.splice(idx, 1); renderInvoiceRows(); }
        function updateInvoiceItem(idx, field, value) {
            if(field === 'id') {
                const s = services.find(x => x.id == value);
                invoiceItems[idx].price = s.price;
                invoiceItems[idx].id = s.id;
            } else {
                invoiceItems[idx][field] = value;
            }
            renderInvoiceRows();
        }

        function renderInvoiceRows() {
            const tbody = document.getElementById('bill-items-body');
            tbody.innerHTML = '';
            let total = 0;
            invoiceItems.forEach((item, idx) => {
                const lineTotal = item.price * item.qty;
                total += lineTotal;
                let options = '';
                services.forEach(s => options += `<option value="${s.id}" ${s.id == item.id ? 'selected' : ''}>${s.name}</option>`);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><select class="form-input" style="padding:6px;" onchange="updateInvoiceItem(${idx}, 'id', this.value)">${options}</select></td><td><input type="number" value="${item.qty}" min="1" style="width:100%; text-align:center; border:1px solid #e2e8f0; border-radius:4px;" onchange="updateInvoiceItem(${idx}, 'qty', this.value)"></td><td style="text-align:right;">RM ${item.price}</td><td style="text-align:right; font-weight:700;">RM ${lineTotal}</td><td><button onclick="removeInvoiceItem(${idx})" style="color:var(--danger); background:none;"><i class="fa-solid fa-times"></i></button></td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('bill-grand-total').innerText = total.toFixed(2);
        }

        async function saveAndPrintInvoice() {
            if(!currentBillAppt.invoice_id) {
                currentBillAppt.invoice_id = await generateInvoiceId(currentBillAppt.date);
            }

            currentBillAppt.items = invoiceItems;
            currentBillAppt.payment_method = document.getElementById('bill-payment-method').value;
            currentBillAppt.status = 'Completed';
            
            await db.collection('klinikazam_appointments').doc(currentBillAppt.id).update({
                items: currentBillAppt.items,
                payment_method: currentBillAppt.payment_method,
                status: 'Completed',
                invoice_id: currentBillAppt.invoice_id
            });

            closeModal('invoiceModal');
            await refreshData(); 
            viewBillDetail(currentBillAppt.id);
            showToast("Saved & Ready to Print");
        }

        async function createCashbill(id) {
            const a = appointments.find(x => x.id === id);
            if(a.invoice_id) {
                showToast("Invoice already exists. Opening details.");
                viewBillDetail(id);
                return;
            }

            const invId = await generateInvoiceId(a.date);
            
            await db.collection('klinikazam_appointments').doc(id).update({
                status: 'Completed',
                payment_method: 'CASH',
                invoice_id: invId
            });

            await refreshData(); 
            showToast("Cashbill Created Successfully");
            renderAppointments();
            renderDashboard();
            viewBillDetail(id);
        }

        // --- PATIENTS CRUD ---
        async function renderPatients() {
            const query = document.querySelector('#view-patients .search-input')?.value.toLowerCase() || '';
            
            const visitCounts = {};
            appointments.forEach(a => {
                if(a.status === 'Completed') {
                    visitCounts[a.patient_id] = (visitCounts[a.patient_id] || 0) + 1;
                }
            });

            let filtered = patients.filter(p => 
                p.name.toLowerCase().includes(query) || 
                p.phone.includes(query) || 
                p.id.includes(query)
            );

            const pagedData = getPaginatedData(filtered, 'patients');
            const tbody = document.querySelector('#patients-table tbody');
            tbody.innerHTML = '';
            
            pagedData.data.forEach(p => {
                const count = visitCounts[p.id] || 0;
                const delBtn = (currentUser.role === 'SuperAdmin') 
                    ? `<button class="btn-sm btn-delete" onclick="requestDelete('patient', '${p.id}')"><i class="fa-solid fa-trash"></i></button>` : '';

                tbody.innerHTML += `
                <tr>
                    <td style="font-weight:600;">${p.name}</td>
                    <td>${p.phone}</td>
                    <td>${p.ic}</td>
                    <td>${count}</td>
                    <td>
                        <button class="btn-sm" onclick="openHistory('${p.id}')"><i class="fa-solid fa-clock-rotate-left"></i></button> 
                        <button class="btn-sm" onclick="openEditPatient('${p.id}')"><i class="fa-solid fa-pen"></i></button> 
                        ${delBtn}
                    </td>
                </tr>`;
            });
            renderPaginationControls('patients', filtered.length);
        }

        function openEditPatient(id) {
            if(!id) {
                document.getElementById('patient-modal-title').innerText = "Add Patient";
                document.getElementById('edit-patient-id').value = '';
                document.getElementById('edit-patient-name').value = '';
                document.getElementById('edit-patient-phone').value = '';
                document.getElementById('edit-patient-ic').value = '';
            } else {
                const p = patients.find(x => x.id === id);
                document.getElementById('patient-modal-title').innerText = "Edit Patient";
                document.getElementById('edit-patient-id').value = id;
                document.getElementById('edit-patient-name').value = p.name;
                document.getElementById('edit-patient-phone').value = p.phone;
                document.getElementById('edit-patient-ic').value = p.ic;
            }
            showModal('editPatientModal');
        }

        async function savePatientEdit() {
            const idInput = document.getElementById('edit-patient-id').value;
            let id = idInput ? idInput : null;
            const name = document.getElementById('edit-patient-name').value;
            const phone = document.getElementById('edit-patient-phone').value;
            const ic = document.getElementById('edit-patient-ic').value;

            if(id) {
                await db.collection('klinikazam_patients').doc(id).update({ name, phone, ic });
            } else {
                id = await generateSmartId('klinikazam_patients', 'PAT');
                const newPat = { id, name, phone, ic: ic || '-' };
                await db.collection('klinikazam_patients').doc(id).set(newPat);
            }

            await refreshData(); 
            renderPatients();
            closeModal('editPatientModal');
            showToast(id ? "Patient Updated" : "Patient Added");
        }

        // --- MANUAL PATIENT HISTORY ---
        function openHistory(patientId) {
            historyPatientId = patientId;
            const p = patients.find(x => x.id === patientId);
            document.getElementById('hist-p-name').innerText = p.name;
            document.getElementById('hist-p-id').innerText = p.id;
            document.getElementById('hist-p-phone').innerText = p.phone;
            
            document.getElementById('hist-date').value = todayStr;

            const history = appointments.filter(a => a.patient_id === patientId && a.status === 'Completed').sort((a,b) => new Date(b.date) - new Date(a.date));
            const tbody = document.getElementById('historyListBody');
            tbody.innerHTML = '';
            if(history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No history found.</td></tr>';
            } else {
                history.forEach(a => {
                    const s = services.find(x => x.id === (a.items && a.items[0] ? a.items[0].id : null));
                    const invId = a.invoice_id || `INV-${a.id}`;
                    tbody.innerHTML += `<tr><td>${a.date}</td><td>${s ? s.name : 'Unknown'}</td><td>${invId}</td></tr>`;
                });
            }
            showModal('historyModal');
        }

        async function saveManualHistory() {
            if(!historyPatientId) return;
            const date = document.getElementById('hist-date').value;
            const sId = parseInt(document.getElementById('hist-service').value);
            const qty = parseInt(document.getElementById('hist-qty').value) || 1;
            const price = parseFloat(document.getElementById('hist-price').value) || 0;
            
            if(!date || !sId) {
                showToast("Please select Date and Service.");
                return;
            }

            const smartId = await generateSmartId('klinikazam_appointments', 'APT');
    const manualInvId = `OLD-${date.replace(/-/g,'')}`;

    const newAppt = {
        id: smartId,
        patient_id: historyPatientId,
        date: date,
        time: "12:00 PM",
        items: [{ id: sId, qty: qty, price: price }],
        status: 'Completed',
        payment_method: 'CASH',
        invoice_id: manualInvId
    };

    await db.collection('klinikazam_appointments').doc(smartId).set(newAppt);
    showToast("Old data added successfully");
    openHistory(historyPatientId);
    await refreshData();
}

// --- STAFF CRUD (UPDATED FOR AUTH) ---
async function renderStaff() {
    const tbody = document.querySelector('#staff-table tbody');
    const saBody = document.querySelector('#superadmin-table tbody');
    
    tbody.innerHTML = '';
    saBody.innerHTML = '';
    
    const query = document.querySelector('#view-staff .search-input')?.value.toLowerCase() || '';
    
    let filtered = staff.filter(s => 
        s.name.toLowerCase().includes(query) || 
        s.role.toLowerCase().includes(query) ||
        s.username.toLowerCase().includes(query)
    );

    const isSuperAdmin = currentUser.role === 'SuperAdmin';
    const isAdmin = currentUser.role === 'Admin';

    const addBtn = document.getElementById('btn-add-staff');
    if(isSuperAdmin || isAdmin) {
        addBtn.style.display = 'inline-flex';
    } else {
        addBtn.style.display = 'none';
    }

    // Separate SuperAdmins and regular staff
    const superAdmins = filtered.filter(s => s.role === 'SuperAdmin');
    const regularStaff = filtered.filter(s => s.role !== 'SuperAdmin');

    // Render SuperAdmins (No Pagination usually for small lists)
    superAdmins.forEach(s => {
        saBody.innerHTML += `<tr><td>${s.id}</td><td style="font-weight:600;">${s.name}</td><td>${s.job_title || '-'}</td><td><span class="badge badge-info">${s.role}</span></td><td>${s.username}<br><small>${s.email||''}</small></td><td>-</td></tr>`;
    });

    // Paginate Regular Staff
    const pagedData = getPaginatedData(regularStaff, 'staff');
    pagedData.data.forEach(s => {
        let editBtn = '';
        let deleteBtn = '';
        let resetBtn = '';

        if(isSuperAdmin) {
            const isSelf = s.id === currentUser.id;
            if(!isSelf) {
                 editBtn = `<button class="btn-sm" onclick="openEditStaff('${s.id}')"><i class="fa-solid fa-pen"></i></button>`;
                 deleteBtn = `<button class="btn-sm btn-delete" onclick="requestDelete('staff', '${s.id}')"><i class="fa-solid fa-trash"></i></button>`;
            }
        } else if(isAdmin) {
             editBtn = `<button class="btn-sm" onclick="openEditStaff('${s.id}')"><i class="fa-solid fa-pen"></i></button>`;
        }

        // Send Password Reset (Only SuperAdmin)
        if(isSuperAdmin && s.email) {
            resetBtn = `<button class="btn-sm btn-reset" onclick="sendPasswordReset('${s.email}')" title="Send Reset Email"><i class="fa-solid fa-key"></i></button>`;
        }

        tbody.innerHTML += `<tr><td>${s.id}</td><td style="font-weight:600;">${s.name}</td><td>${s.job_title || '-'}</td><td><span class="badge badge-info">${s.role}</span></td><td>${s.username}<br><small>${s.email||''}</small></td><td>${editBtn} ${resetBtn} ${deleteBtn}</td></tr>`;
    });

    renderPaginationControls('staff', regularStaff.length);
}

function openEditStaff(id) {
    if(currentUser.role === 'Staff') return;

    if(!id) {
        if(currentUser.role !== 'SuperAdmin' && currentUser.role !== 'Admin') {
            showToast("Unauthorized");
            return;
        }
        document.getElementById('staff-modal-title').innerText = "Add Staff";
        document.getElementById('edit-staff-id').value = '';
        document.getElementById('edit-staff-name').value = '';
        document.getElementById('edit-staff-jobtitle').value = 'Assistant';
        document.getElementById('edit-staff-role').value = 'Staff';
        document.getElementById('edit-staff-u').value = '';
        document.getElementById('edit-staff-p').value = '';
        document.getElementById('edit-staff-email').value = '';
        generateSmartId('klinikazam_staff', 'KPA').then(sid => {
            document.getElementById('edit-staff-sid').value = sid;
        });
    } else {
        const s = staff.find(x => x.id === id);
        if(currentUser.role === 'Admin' && s.role === 'SuperAdmin') {
            showToast("Unauthorized to edit SuperAdmin");
            return;
        }
        document.getElementById('staff-modal-title').innerText = "Edit Staff";
        document.getElementById('edit-staff-id').value = id;
        document.getElementById('edit-staff-sid').value = s.id;
        document.getElementById('edit-staff-name').value = s.name;
        document.getElementById('edit-staff-jobtitle').value = s.job_title || 'Staff';
        document.getElementById('edit-staff-role').value = s.role;
        document.getElementById('edit-staff-u').value = s.username;
        document.getElementById('edit-staff-p').value = ''; 
        document.getElementById('edit-staff-email').value = s.email || '';
    }
    showModal('editStaffModal');
}

async function sendPasswordReset(email) {
    if(confirm(`Send                 password reset email to ${email}?`)) {
                try {
                    await auth.sendPasswordResetEmail(email);
                    showToast("Reset email sent!");
                } catch(e) {
                    showToast("Error sending email.");
                }
            }
        }

        async function saveStaffEdit() {
            const idInput = document.getElementById('edit-staff-id').value;
            let id = idInput ? idInput : null;
            const name = document.getElementById('edit-staff-name').value;
            const jobTitle = document.getElementById('edit-staff-jobtitle').value;
            const role = document.getElementById('edit-staff-role').value;
            const email = document.getElementById('edit-staff-email').value;
            const u = document.getElementById('edit-staff-u').value;
            const p = document.getElementById('edit-staff-p').value;

            if(!email.includes('@')) { showToast("Invalid email address"); return; }

            if(currentUser.role === 'Admin' && role === 'SuperAdmin') {
                showToast("Admins cannot create SuperAdmin accounts.");
                return;
            }

            if(id) {
                // Update existing
                const targetStaff = staff.find(x => x.id === id);
                if(currentUser.role === 'Admin' && targetStaff.role === 'SuperAdmin') {
                    showToast("Unauthorized");
                    return;
                }
                const updateData = { name, job_title: jobTitle, username: u, email };
                if(role !== targetStaff.role) updateData.role = role; 
                // Password update handled via Reset Email flow usually, or if provided
                // We can't easily update password in Firebase Auth without re-auth.
                // We will skip password update here to keep logic simple and secure, rely on Reset.
                await db.collection('klinikazam_staff').doc(id).update(updateData);
            } else {
                // New Staff - Create Auth User
                if(!p || p.length < 6) { showToast("Password must be at least 6 chars"); return; }
                
                try {
                    showLoading(true);
                    // Check if email exists in Firestore first
                    const existing = await db.collection('klinikazam_staff').where('email', '==', email).get();
                    if(!existing.empty) {
                        throw new Error("Email already in use by another staff.");
                    }

                    const userCredential = await auth.createUserWithEmailAndPassword(email, p);
                    
                    const smartId = await generateSmartId('klinikazam_staff', 'KPA');
                    const newStaff = { 
                        id: smartId, 
                        name, 
                        job_title: jobTitle, 
                        role, 
                        username: u,
                        email: email
                    };
                    await db.collection('klinikazam_staff').doc(smartId).set(newStaff);
                    
                    // Sign out the newly created user immediately so we stay logged in as Admin
                    await userCredential.user.delete(); 
                    
                    showToast("Staff Created. Please log in again to continue.");
                    setTimeout(() => location.reload(), 2000);

                } catch(e) {
                    console.error(e);
                    if(e.code === 'auth/email-already-in-use') showToast("Email already registered in Auth.");
                    else if(e.code === 'auth/weak-password') showToast("Password is too weak.");
                    else showToast(e.message);
                    showLoading(false);
                    return;
                }
                return; // Return early as reload handles UI
            }

            await refreshData(); 
            renderStaff();
            closeModal('editStaffModal');
            showToast(id ? "Staff Updated" : "Staff Added");
            showLoading(false);
        }

        // --- SERVICES CRUD ---
        async function renderServices() {
            const tbody = document.querySelector('#services-table tbody');
            tbody.innerHTML = '';
            services.forEach(s => {
                const delBtn = (currentUser.role === 'SuperAdmin') 
                    ? `<button class="btn-sm btn-delete" onclick="requestDelete('service', '${s.id}')"><i class="fa-solid fa-trash"></i></button>` : '';

                tbody.innerHTML += `<tr><td>${s.name}</td><td style="font-weight:700;">RM ${s.price}</td><td><button class="btn-sm" onclick="openEditService('${s.id}')"><i class="fa-solid fa-pen"></i></button> ${delBtn}</td></tr>`;
            });
        }

        function openEditService(id) {
            if(!id) {
                document.getElementById('service-modal-title').innerText = "Add Service";
                document.getElementById('edit-service-id').value = '';
                document.getElementById('edit-service-name').value = '';
                document.getElementById('edit-service-price').value = '';
            } else {
                const s = services.find(x => x.id == id); 
                document.getElementById('service-modal-title').innerText = "Edit Service";
                document.getElementById('edit-service-id').value = id;
                document.getElementById('edit-service-name').value = s.name;
                document.getElementById('edit-service-price').value = s.price;
            }
            showModal('editServiceModal');
        }

        async function saveServiceEdit() {
            const idInput = document.getElementById('edit-service-id').value;
            const id = idInput ? parseInt(idInput) : null;
            const name = document.getElementById('edit-service-name').value;
            const price = parseFloat(document.getElementById('edit-service-price').value);

            if(id) {
                // Update existing service
                await db.collection('klinikazam_services').doc(id.toString()).update({ name, price });
            } else {
                // Create new service
                const newSvc = { id: Date.now(), name, price }; 
                await db.collection('klinikazam_services').doc(newSvc.id.toString()).set(newSvc);
            }

            await refreshData(); 
            renderServices();
            closeModal('editServiceModal');
            showToast(id ? "Service Updated" : "Service Added");
        }

        // --- SLOT MANAGEMENT ---
        async function renderSlots() {
            const dateVal = document.getElementById('slotDate').value;
            const grid = document.getElementById('slotGrid');
            const btn = document.getElementById('clinicStatusBtn');
            grid.innerHTML = `<div style="grid-column: 1/-1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 150px;"><div class="spinner"></div></div>`;

            const isClosed = slotExceptions.some(e => e.date === dateVal && e.type === 'closed');
            
            grid.innerHTML = '';
            if(isClosed) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px; color:var(--text-light); background:#fff; border-radius:12px; font-weight:600;">Clinic Closed</div>';
                btn.innerHTML = '<i class="fa-solid fa-toggle-off"></i> Open Clinic';
                return;
            } else {
                btn.innerHTML = '<i class="fa-solid fa-toggle-on"></i> Set as Closed';
            }

            const blocked = slotExceptions.filter(e => e.date === dateVal && e.type === 'blocked').map(e => e.time);
            const bookedAppts = appointments.filter(a => a.date === dateVal && a.status !== 'Cancelled' && a.status !== 'Completed');
            
            defaultSlots.forEach(time => {
                const isBlocked = blocked.includes(time);
                const booking = bookedAppts.find(a => a.time === time);
                const p = booking ? patients.find(pt => pt.id === booking.patient_id) : null;
                const btnDiv = document.createElement('div');
                let className = 'slot-btn';
                
                if (booking) {
                    className += ' booked';
                    btnDiv.innerHTML = `${time}<br><small>${p ? p.name : 'Unknown'}</small>`;
                } else if (isBlocked) {
                    className += ' blocked';
                    btnDiv.innerHTML = `${time}<br><small>Break</small>`;
                    // Clicking a blocked slot unblocks it
                    btnDiv.onclick = () => toggleSlot(dateVal, time, btnDiv);
                } else {
                    btnDiv.innerHTML = time;
                    // Clicking an available slot blocks it
                    btnDiv.onclick = () => toggleSlot(dateVal, time, btnDiv);
                }
                btnDiv.className = className;
                grid.appendChild(btnDiv);
            });
        }

        async function toggleSlot(date, time, el) {
            // Check current status
            const isCurrentlyBlocked = el.classList.contains('blocked');
            const action = isCurrentlyBlocked ? "unblock" : "block";
            
            if(confirm(`Sure to ${action} time for ${date} at ${time}?`)) {
                const idx = slotExceptions.findIndex(e => e.date === date && e.time === time && e.type === 'blocked');
                if(idx === -1) {
                    // Add Block
                    await db.collection('klinikazam_slots').add({ id: Date.now(), date, time, type: 'blocked' });
                } else {
                    // Remove Block (Unblock)
                    await db.collection('klinikazam_slots').doc(slotExceptions[idx].id).delete();
                }
                await refreshData();
                renderSlots(); 
            }
        }

        async function toggleClinicStatus() {
            const date = document.getElementById('slotDate').value;
            const idx = slotExceptions.findIndex(e => e.date === date && e.type === 'closed');
            
            if(idx === -1) { 
                // Close Clinic
                await db.collection('klinikazam_slots').add({ id: Date.now(), date, type: 'closed' });
            } else { 
                // Open Clinic
                await db.collection('klinikazam_slots').doc(slotExceptions[idx].id).delete();
            }
            await refreshData();
            renderSlots();
        }

        // --- DELETE LOGIC ---
        let deleteTarget = null;
        function requestDelete(type, id) {
            if(currentUser.role !== 'SuperAdmin') {
                showToast("Unauthorized: SuperAdmin access required");
                return;
            }
            deleteTarget = { type, id };
            if(confirm(`Are you sure you want to PERMANENTLY DELETE this ${type}? This cannot be undone.`)) {
                executeDeleteAction();
            }
        }

        async function executeDeleteAction() {
            let error = null;
            
            if (deleteTarget.type === 'appointment') {
                await db.collection('klinikazam_appointments').doc(deleteTarget.id).delete();
            }
            else if (deleteTarget.type === 'service') {
                await db.collection('klinikazam_services').doc(deleteTarget.id.toString()).delete();
            }
            else if (deleteTarget.type === 'staff') {
                const s = staff.find(x => x.id === deleteTarget.id);
                if(s.role === 'SuperAdmin') {
                    showToast("Cannot delete SuperAdmin accounts");
                    return;
                }
                await db.collection('klinikazam_staff').doc(deleteTarget.id).delete();
            }
            else if (deleteTarget.type === 'patient') {
                await db.collection('klinikazam_patients').doc(deleteTarget.id).delete();
            }

            await refreshData(); 
            showToast("Deleted Successfully");
        }

        // --- WHATSAPP MESSAGING (UPDATED) ---
        function sendWhatsapp(name, date, time, phone) {
            let cleanPhone = phone.replace(/[^0-9]/g, '');
            if(cleanPhone.startsWith('0')) cleanPhone = '60' + cleanPhone.substring(1);
            const displayDate = formatDateDisplay(date);
            
            //  1) WhatsApp Auto Reminder (Sebelum Temujanji)
            // Determining message type based on status or context usually, 
            // but here assuming 'Pending' appointment gets a reminder.
            // If status is 'Completed', we send "Thank You" message.
            
            let message = "";
            const appt = appointments.find(a => a.date === date && a.time === time);
            const status = appt ? appt.status : 'Pending'; // Default to pending if unknown

            if (status === 'Completed') {
                //  2) WhatsApp Thank You (Selepas Lawatan Pesakit)
                message = `Terima kasih kerana berkunjung ke Azam Dental SP Saujana hari ini.

Kami berharap rawatan yang diberikan memuaskan.
Sekiranya terdapat sebarang ketidakselesaan atau pertanyaan selepas rawatan, sila hubungi kami.

Kami menghargai kepercayaan anda dan berharap dapat berkhidmat kepada anda lagi.
 Azam Dental SP Saujana`;
            } else {
                //  1) WhatsApp Auto Reminder (Sebelum Temujanji)
                message = `Assalamualaikum & Salam Sejahtera,

Ini adalah peringatan temujanji anda bersama Azam Dental SP Saujana:

 ${displayDate}
 ${time}

Sila hadir 510 minit lebih awal bagi memastikan rawatan berjalan lancar dan tidak mengganggu pesakit seterusnya.
Jika perlu ubah atau batalkan temujanji, mohon maklumkan sekurang-kurangnya 30 minit lebih awal.

Sila sahkan kehadiran dengan membalas mesej ini.
Terima kasih.
 Azam Dental SP Saujana`;
            }

            const encodedMsg = encodeURIComponent(message);
            const url = `https://wa.me/${cleanPhone}?text=${encodedMsg}`;
            window.open(url, '_blank');
        }

        function populateServiceDropdowns() {
            const sSelects = ['bk-service', 'edit-appt-service', 'hist-service'];
            sSelects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.innerHTML = '<option value="" disabled selected>-- Choose Service --</option>';
                    services.forEach(s => el.innerHTML += `<option value="${s.id}">${s.name} (RM ${s.price})</option>`);
                }
            });
        }

        // --- MODALS & TOASTS ---
        function showModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        function showToast(msg) {
            const t = document.getElementById('toast'); 
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('hide');
            t.classList.add('show');
            setTimeout(() => {
                t.classList.remove('show');
                t.classList.add('hide');
            }, 3000);
        }

        function openCancelConfirm(id) {
            document.getElementById('cancel-appt-id').value = id;
            showModal('confirmCancelModal');
        }

        async function executeCancel() {
            const id = document.getElementById('cancel-appt-id').value;
            await db.collection('klinikazam_appointments').doc(id).update({ status: 'Cancelled' });
            await refreshData(); 
            closeModal('confirmCancelModal');
            showToast("Appointment Cancelled");
        }

        function openProfile() {
            showModal('profileModal');
        }

        function toggleCancelledTable() {
            const container = document.getElementById('cancelled-container');
            const btn = document.getElementById('toggleCancelledBtn');
            if(container.style.display === 'none') {
                container.style.display = 'block';
                btn.innerText = "Hide Cancelled";
            } else {
                container.style.display = 'none';
                btn.innerText = "Show Cancelled";
            }
        }

        function handleSearch(type, val) {
            if(type === 'staff') renderStaff();
            if(type === 'patients') renderPatients();
            if(type === 'appointments') renderAppointments();
            if(type === 'billing') renderBilling();
            if(type === 'cashbill') renderCashbillList();
        }
    </script>
</body>
</html>
