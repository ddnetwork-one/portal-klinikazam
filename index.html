<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal - Klinik Pergigian Azam</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- VARIABLES --- */
        :root {
            --primary: #0284c7; --primary-dark: #0c4a6e; --primary-light: #e0f2fe; --secondary: #38bdf8; 
            --success: #10b981; --success-bg: #dcfce7;
            --warning: #f59e0b; --warning-bg: #fef3c7;
            --danger: #ef4444; --danger-bg: #fee2e2;
            --info: #3b82f6; --info-bg: #dbeafe;
            --wa-color: #25D366; --wa-bg: #dcfce7;
            --bg-body: #f1f5f9; --bg-sidebar: #ffffff; --bg-card: #ffffff;
            --text-main: #1e293b; --text-muted: #64748b; --border-light: #e2e8f0;
            --sidebar-width: 280px; --header-height: 80px; --radius: 20px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05); --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* --- BASE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }
        h1, h2, h3, h4, h5 { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700; color: var(--text-main); letter-spacing: -0.02em; }
        button { cursor: pointer; border: none; font-family: inherit; transition: var(--transition); }
        input, select, textarea { font-family: inherit; }

        /* --- LOGIN & LOGO --- */
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; opacity: 1; transition: 0.5s; }
        #login-screen.hidden { opacity: 0; pointer-events: none; }
        .login-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); padding: 50px; border-radius: 30px; width: 100%; max-width: 450px; box-shadow: 0 30px 60px -12px rgba(14, 165, 233, 0.15); text-align: center; animation: floatUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); border: 1px solid rgba(255,255,255,0.8); }
        @keyframes floatUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .logo-img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .logo-large { width: 90px; height: 90px; object-fit: cover; border-radius: 20px; border: 4px solid white; box-shadow: 0 8px 20px rgba(2, 132, 199, 0.2); }
        .form-input { width: 100%; padding: 16px 20px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 0.95rem; transition: var(--transition); }
        .form-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.1); }
        .btn-primary { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; font-weight: 700; font-size: 1rem; border-radius: 14px; box-shadow: 0 10px 20px -5px rgba(2, 132, 199, 0.3); display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 25px -5px rgba(2, 132, 199, 0.4); }

        /* --- SIDEBAR --- */
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border-light); display: flex; flex-direction: column; position: relative; z-index: 50; }
        .brand { height: var(--header-height); display: flex; align-items: center; padding: 0 30px; font-size: 1.25rem; font-weight: 800; color: var(--primary-dark); border-bottom: 1px solid #f1f5f9; }
        .nav-menu { flex: 1; padding: 30px 20px; list-style: none; }
        .nav-item { display: flex; align-items: center; padding: 14px 20px; margin-bottom: 8px; color: var(--text-muted); font-weight: 600; border-radius: 14px; cursor: pointer; transition: var(--transition); font-size: 0.95rem; }
        .nav-item i { width: 28px; font-size: 1.2rem; margin-right: 15px; text-align: center; color: var(--primary); }
        .nav-item:hover { background: #f0f9ff; color: var(--primary); transform: translateX(5px); }
        .nav-item.active { background: linear-gradient(90deg, var(--primary-light) 0%, white 100%); color: var(--primary); border-left: 4px solid var(--primary); border-radius: 0 14px 14px 0; padding-left: 16px; }
        .sidebar-footer { padding: 24px; border-top: 1px solid #f1f5f9; }
        .user-pill { display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 16px; background: #f8fafc; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .user-pill:hover { border-color: var(--primary); background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; }

        /* --- HEADER --- */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: var(--header-height); background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-light); display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 0 40px; position: sticky; top: 0; z-index: 40; }
        .content-area { flex: 1; padding: 40px 50px; overflow-y: auto; }

        /* --- LIVE TIME (CENTERED) --- */
        .header-center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .live-clock-container { display: flex; align-items: center; gap: 10px; background: white; padding: 8px 16px; border-radius: 12px; border: 1px solid var(--border-light); box-shadow: var(--shadow-sm); }
        .live-time { font-family: 'Inter', sans-serif; font-variant-numeric: tabular-nums; font-weight: 700; font-size: 1.1rem; color: var(--primary); letter-spacing: 1px; }
        .live-date { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

        /* --- COMPONENTS --- */
        .section-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); padding: 30px; margin-bottom: 30px; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .table-header h3 { font-size: 1.25rem; color: var(--text-main); }
        .table-responsive { overflow-x: auto; border-radius: 16px; border: 1px solid var(--border-light); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { text-align: left; padding: 18px 24px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); background: #f8fafc; font-weight: 700; }
        td { padding: 18px 24px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; color: var(--text-main); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fcfcfc; }

        .badge { padding: 6px 14px; border-radius: 30px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .badge-pending { background: var(--warning-bg); color: #b45309; }
        .badge-confirmed { background: var(--info-bg); color: #1d4ed8; }
        .badge-completed { background: var(--success-bg); color: #15803d; }
        .badge-cancelled { background: var(--danger-bg); color: #b91c1c; }

        .btn-sm { padding: 10px 18px; border-radius: 10px; font-size: 0.85rem; font-weight: 600; border: 1px solid var(--border-light); background: white; color: var(--text-main); transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-sm:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-1px); }
        .btn-bill { background: var(--primary); color: white; border: none; box-shadow: 0 4px 10px rgba(2, 132, 199, 0.2); }
        .btn-bill:hover { background: var(--primary-dark); box-shadow: 0 6px 12px rgba(2, 132, 199, 0.3); }
        .btn-delete { color: var(--danger); border-color: #fee2e2; background: #fff; }
        .btn-delete:hover { background: var(--danger-bg); border-color: #fecaca; }
        
        .btn-wa { color: var(--wa-color); border-color: #dcfce7; background: #fff; }
        .btn-wa:hover { background: var(--wa-bg); border-color: #bbf7d0; }

        /* --- LOADING SPINNER --- */
        .spinner-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 0;
            min-height: 200px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(2, 132, 199, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            position: relative;
        }
        .spinner::after {
            content: '';
            position: absolute;
            top: 4px; left: 4px; right: 4px; bottom: 4px;
            border: 4px solid rgba(2, 132, 199, 0.2);
            border-top-color: transparent;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite reverse;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text {
            margin-top: 15px;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(6px); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 24px; box-shadow: var(--shadow-lg); overflow: hidden; transform: scale(0.9); transition: 0.3s; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-header { padding: 25px 30px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-body { padding: 30px; overflow-y: auto; }
        .modal-footer { padding: 20px 30px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 12px; }

        /* --- ORGANIZATION CHART --- */
        .org-tree { list-style: none; padding-left: 20px; position: relative; }
        .org-tree li { margin: 10px 0; position: relative; }
        .org-tree li::before { content: ''; position: absolute; top: 24px; left: -20px; border-top: 2px solid #cbd5e1; width: 20px; }
        .org-tree li::after { content: ''; position: absolute; top: 0; left: -20px; height: 100%; border-left: 2px solid #cbd5e1; }
        .org-tree li:last-child::after { height: 24px; }
        .org-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; }
        .org-item i { color: var(--primary); }

        /* --- SLOTS (UPDATED STYLES) --- */
        .slot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; margin-top: 25px; }
        .slot-btn { 
            padding: 15px; text-align: center; border: 2px solid #e2e8f0; border-radius: 12px; background: white; 
            font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; height: 80px;
        }
        .slot-btn:hover:not(.booked):not(.blocked) { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .slot-btn.blocked { border-color: #fca5a5; color: #ef4444; background: #fee2e2; opacity: 0.7; text-decoration: line-through; cursor: pointer; }
        .slot-btn.booked { 
            border-color: var(--primary); 
            background: var(--info-bg); 
            color: var(--primary-dark); 
            cursor: not-allowed; 
            opacity: 0.8;
        }
        .slot-btn.booked::after {
            content: '\f0f0'; /* FontAwesome User */
            font-family: 'Font Awesome 6 Free'; 
            font-weight: 900;
            font-size: 1.5rem;
            position: absolute;
            right: 5px;
            bottom: 5px;
            opacity: 0.1;
        }
        .slot-btn.booked small { font-size: 0.7rem; color: var(--primary-dark); text-decoration: none; margin-top: 4px; }


        /* --- PRINTABLE INVOICE --- */
        #printable-invoice { display: none; }
        @media print {
            body * { visibility: hidden; }
            #printable-invoice, #printable-invoice * { visibility: visible; }
            #printable-invoice { position: absolute; left: 0; top: 0; width: 100%; display: block; background: white; color: black; padding: 50px; }
            .no-print { display: none !important; }
            .print-logo { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; margin-bottom: 20px; }
        }

        /* --- VIEWS --- */
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        /* --- TOAST --- */
        #toast { position: fixed; bottom: 40px; right: 40px; background: #1e293b; color: white; padding: 18px 28px; border-radius: 16px; transform: translateY(200%); transition: 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s; z-index: 200; box-shadow: 0 15px 30px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; font-weight: 500; }
        #toast.show { transform: translateY(0); opacity: 1; }
        #toast.hide { transform: translateY(200%); opacity: 0; }

        /* --- REPORTS STYLES --- */
        .sales-summary { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; background: linear-gradient(135deg, var(--success), #059669); color: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4); }
        .sales-big-number { font-size: 3rem; font-weight: 800; line-height: 1; }

    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/ddnetwork-ent/clinic-azam-dental/main/IMG_2260.JPG" alt="Logo" class="logo-large">
            <h2 style="margin-top: 20px; margin-bottom: 8px; color: var(--primary-dark);">Klinik Azam</h2>
            <p style="margin-bottom: 35px; color: var(--text-muted); font-weight: 500;">Cawangan (SP Saujana)</p>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div style="text-align:left; margin-bottom:18px;">
                    <label style="font-size:0.85rem; font-weight:700; color:var(--text-muted);">Username</label>
                    <input type="text" id="username" class="form-input" placeholder="staff_username" required>
                </div>
                <div style="text-align:left; margin-bottom:28px;">
                    <label style="font-size:0.85rem; font-weight:700; color:var(--text-muted);">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="password" required>
                </div>
                <button type="submit" class="btn-primary">Sign In <i class="fa-solid fa-arrow-right"></i></button>
                <p id="loginError" style="color: var(--danger); font-size: 0.85rem; margin-top: 20px;"></p>
            </form>
        </div>
    </div>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="brand">
            <img src="https://raw.githubusercontent.com/ddnetwork-ent/clinic-azam-dental/main/IMG_2260.JPG" alt="Logo" class="logo-img" style="margin-right:15px;">
            Klinik Azam <br>(SP Saujana)
        </div>
        <ul class="nav-menu">
            <li class="nav-item active" onclick="navigateTo('dashboard')"><i class="fa-solid fa-chart-pie"></i> Dashboard</li>
            <li class="nav-item" onclick="navigateTo('appointments')"><i class="fa-regular fa-calendar-check"></i> Appointments</li>
            <li class="nav-item" onclick="navigateTo('booking')"><i class="fa-solid fa-calendar-plus"></i> New Booking</li>
            <li class="nav-item" onclick="navigateTo('reports')"><i class="fa-solid fa-chart-line"></i> Reports</li>
            <li class="nav-item" onclick="navigateTo('staff')"><i class="fa-solid fa-users-cog"></i> Staff Mgmt</li>
            <li class="nav-item" onclick="navigateTo('patients')"><i class="fa-solid fa-user-doctor"></i> Patients</li>
            <li class="nav-item" onclick="navigateTo('services')"><i class="fa-solid fa-notes-medical"></i> Services</li>
            <li class="nav-item" onclick="navigateTo('slots')"><i class="fa-regular fa-clock"></i> Slot Mgmt</li>
        </ul>
        <div class="sidebar-footer">
            <div class="user-pill" onclick="openProfile()">
                <div class="avatar" id="userAvatar">DA</div>
                <div>
                    <div style="font-weight:700; font-size:0.9rem;" id="userNameDisplay">Dr. Amalina</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);" id="userRoleDisplay">Admin</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-wrapper">
        <!-- UPDATED HEADER LAYOUT -->
        <header>
            <div class="header-left">
                <h2 id="pageTitle">Dashboard</h2>
                <p style="color:var(--text-muted); font-weight:500; font-size: 0.9rem;" id="currentFullDate">Saturday, January 31, 2026</p>
            </div>
            
            <div class="header-center">
                <div class="live-clock-container">
                    <i class="fa-regular fa-clock" style="color: var(--primary);"></i>
                    <span id="liveClock" class="live-time">00:00:00</span>
                </div>
            </div>

            <div class="header-right" style="text-align:right;">
                <button onclick="logout()" class="btn-sm" style="color: var(--danger); border-color: #fee2e2; font-size: 0.9rem;"><i class="fa-solid fa-power-off"></i> Logout</button>
            </div>
        </header>

        <div class="content-area">
            
            <!-- DASHBOARD -->
            <section id="view-dashboard" class="view-section active">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 35px;">
                    <div class="section-card" style="display:flex; justify-content:space-between; align-items:center; padding:25px;">
                        <div><h3 style="font-size:2rem; margin-bottom:5px;" id="d-stat-today">0</h3><p style="color:var(--text-muted); font-weight:600;">Today's Appts</p></div>
                        <div style="width:55px; height:55px; background:var(--primary-light); color:var(--primary); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:1.5rem;"><i class="fa-regular fa-calendar"></i></div>
                    </div>
                    <div class="section-card" style="display:flex; justify-content:space-between; align-items:center; padding:25px;">
                        <div><h3 style="font-size:2rem; margin-bottom:5px;" id="d-stat-sales">RM 0</h3><p style="color:var(--text-muted); font-weight:600;">Today's Sales</p></div>
                        <div style="width:55px; height:55px; background:var(--success-bg); color:var(--success); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:1.5rem;"><i class="fa-solid fa-coins"></i></div>
                    </div>
                    <div class="section-card" style="display:flex; justify-content:space-between; align-items:center; padding:25px;">
                        <div><h3 style="font-size:2rem; margin-bottom:5px;" id="d-stat-history">0</h3><p style="color:var(--text-muted); font-weight:600;">Total History</p></div>
                        <div style="width:55px; height:55px; background:var(--warning-bg); color:var(--warning); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:1.5rem;"><i class="fa-solid fa-check-double"></i></div>
                    </div>
                </div>
                <div class="section-card">
                    <div class="table-header"><h3><i class="fa-solid fa-clock" style="color:var(--primary); margin-right:10px;"></i>Today's Schedule</h3></div>
                    <div class="table-responsive"><table id="dashboard-table"><thead><tr><th>Time</th><th>Patient</th><th>Service</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- APPOINTMENTS -->
            <section id="view-appointments" class="view-section">
                <div class="section-card">
                    <div class="table-header"><h3>Upcoming Schedule</h3></div>
                    <div class="table-responsive"><table id="today-table"><thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Phone</th><th>Service</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
                <div class="section-card">
                    <div class="table-header"><h3>Patient History (Completed)</h3></div>
                    <div class="table-responsive"><table id="history-table"><thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Service</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
                <!-- CANCELLED WITH TOGGLE -->
                <div class="section-card" style="border-left: 4px solid var(--danger);">
                    <div class="table-header">
                        <h3 style="color:var(--danger);"><i class="fa-solid fa-ban" style="margin-right:10px;"></i> Cancelled Appointments</h3>
                        <button class="btn-sm" id="toggleCancelledBtn" onclick="toggleCancelledTable()">Show Cancelled</button>
                    </div>
                    <div id="cancelled-container" style="display:none;">
                        <div class="table-responsive"><table id="cancelled-table"><thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Service</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </section>

            <!-- REPORTS (NEW SECTION) -->
            <section id="view-reports" class="view-section">
                <div class="sales-summary">
                    <div>
                        <p style="opacity:0.9; font-weight:600; margin-bottom:5px;">Total Sales for <span id="report-date-label">Today</span></p>
                        <div class="sales-big-number">RM <span id="report-total-amount">0.00</span></div>
                    </div>
                    <div style="text-align:right;">
                        <i class="fa-solid fa-chart-pie" style="font-size:4rem; opacity:0.2;"></i>
                    </div>
                </div>
                <div class="section-card">
                    <div class="table-header">
                        <h3>Transaction Details</h3>
                        <input type="date" id="report-date-picker" class="form-input" style="width:auto;" onchange="updateReports()">
                    </div>
                    <div class="table-responsive"><table id="report-table"><thead><tr><th>Time</th><th>Patient</th><th>Items</th><th>Total</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- BOOKING -->
            <section id="view-booking" class="view-section">
                <div class="section-card" style="max-width: 650px; margin: 0 auto;">
                    <div class="table-header">
                        <h3><i class="fa-solid fa-calendar-plus" style="color:var(--primary); margin-right:10px;"></i>Book Appointment</h3>
                    </div>
                    <p style="margin-bottom:25px; color:var(--text-muted);">Select a date. The time slots will automatically filter to show only available times.</p>
                    <form onsubmit="saveNewBooking(event)">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                            <div><label style="display:block; margin-bottom:10px; font-weight:700;">Patient Name</label><input type="text" id="bk-name" class="form-input" placeholder="Full Name" required></div>
                            <div><label style="display:block; margin-bottom:10px; font-weight:700;">Phone Number</label><input type="tel" id="bk-phone" class="form-input" placeholder="012-3456789" required></div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                            <div>
                                <label style="display:block; margin-bottom:10px; font-weight:700;">Date <span style="font-size:0.8rem; color:var(--text-muted); font-weight:400;">(Today or Upcoming)</span></label>
                                <input type="date" id="bk-date" class="form-input" required onchange="updateBookingTimeOptions()">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:10px; font-weight:700;">Available Time</label>
                                <select id="bk-time" class="form-input" required disabled>
                                    <option value="">Select Date First</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom:30px;"><label style="display:block; margin-bottom:10px; font-weight:700;">Primary Service</label><select id="bk-service" class="form-input"></select></div>
                        <button type="submit" class="btn-primary"><i class="fa-solid fa-check"></i> Confirm Booking</button>
                    </form>
                </div>
            </section>

            <!-- STAFF MANAGEMENT -->
            <section id="view-staff" class="view-section">
                <div class="section-card">
                    <div class="table-header">
                        <h3><i class="fa-solid fa-users-cog" style="color:var(--primary); margin-right:10px;"></i> Staff Directory</h3>
                        <button class="btn-sm" onclick="openEditStaff()"><i class="fa-solid fa-user-plus"></i> Add Staff</button>
                    </div>
                    <div class="table-responsive"><table id="staff-table"><thead><tr><th>Name</th><th>Role</th><th>ID</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- PATIENTS -->
            <section id="view-patients" class="view-section">
                <div class="section-card">
                    <div class="table-header"><h3>Patient Directory</h3></div>
                    <div class="table-responsive"><table id="patients-table"><thead><tr><th>Name</th><th>Phone</th><th>Visits</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- SERVICES -->
            <section id="view-services" class="view-section">
                <div class="section-card">
                    <div class="table-header"><h3>Clinic Services & Pricing</h3></div>
                    <div class="table-responsive"><table id="services-table"><thead><tr><th>Service</th><th>Price</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- SLOTS -->
            <section id="view-slots" class="view-section">
                <div class="section-card">
                    <div class="table-header">
                        <h3>Manage Availability</h3>
                        <button class="btn-sm" onclick="toggleClinicStatus()" id="clinicStatusBtn"><i class="fa-solid fa-toggle-on"></i> Set as Closed</button>
                    </div>
                    <input type="date" id="slotDate" class="form-input" style="width:auto;" onchange="renderSlots()">
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">
                        <span style="font-weight:700; color:var(--primary);">Blue</span> = Booked by Patient (Read Only) | 
                        <span style="font-weight:700; color:var(--danger);">Red</span> = Break (Click to toggle) | 
                        <span style="font-weight:700; color:var(--text-muted);">White</span> = Available
                    </p>
                    <div class="slot-grid" id="slotGrid"></div>
                </div>
            </section>

        </div>
    </div>

    <!-- MODALS -->
    <!-- 1. Delete Approval Modal -->
    <div class="modal-overlay" id="pinModal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h3><i class="fa-solid fa-shield-halved" style="color:var(--warning);"></i> Admin Approval</h3>
                <button onclick="closeModal('pinModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:15px; color:var(--text-muted);">This action requires Admin permission. Please enter PIN.</p>
                <input type="password" id="adminPinInput" class="form-input" placeholder="PIN (1234)">
                <p id="pinError" style="color:var(--danger); font-size:0.8rem; margin-top:10px;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('pinModal')">Cancel</button>
                <button class="btn-sm btn-delete" onclick="confirmDeleteAction()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- 2. Edit Appointment Modal -->
    <div class="modal-overlay" id="editApptModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Edit Appointment</h3><button onclick="closeModal('editApptModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-appt-id">
                <div style="margin-bottom:20px;"><label style="font-size:0.85rem; font-weight:700;">Date</label><input type="date" id="edit-appt-date" class="form-input" onchange="updateEditTimeOptions()"></div>
                <div style="margin-bottom:20px;"><label style="font-size:0.85rem; font-weight:700;">Time</label><select id="edit-appt-time" class="form-input"></select></div>
                <div style="margin-bottom:20px;"><label style="font-size:0.85rem; font-weight:700;">Service</label><select id="edit-appt-service" class="form-input"></select></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editApptModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:12px 24px;" onclick="saveApptEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- 3. Edit Service Modal -->
    <div class="modal-overlay" id="editServiceModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Edit Service</h3><button onclick="closeModal('editServiceModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-service-id">
                <div style="margin-bottom:20px;"><label style="font-size:0.85rem; font-weight:700;">Service Name</label><input type="text" id="edit-service-name" class="form-input"></div>
                <div style="margin-bottom:20px;"><label style="font-size:0.85rem; font-weight:700;">Price (RM)</label><input type="number" id="edit-service-price" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editServiceModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:12px 24px;" onclick="saveServiceEdit()">Update</button>
            </div>
        </div>
    </div>

    <!-- 4. Staff Edit Modal -->
    <div class="modal-overlay" id="editStaffModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Manage Staff</h3><button onclick="closeModal('editStaffModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-staff-id">
                <div style="margin-bottom:20px;"><label style="font-size:0.85rem; font-weight:700;">Staff Name</label><input type="text" id="edit-staff-name" class="form-input"></div>
                <div style="margin-bottom:20px;"><label style="font-size:0.85rem; font-weight:700;">Role</label><select id="edit-staff-role" class="form-input">
                    <option value="Dentist">Dentist</option>
                    <option value="Nurse">Nurse</option>
                    <option value="Assistant">Assistant</option>
                    <option value="Admin">Admin</option>
                </select></div>
                <div style="margin-bottom:20px;"><label style="font-size:0.85rem; font-weight:700;">Username</label><input type="text" id="edit-staff-u" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editStaffModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:12px 24px;" onclick="saveStaffEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- 5. Patient History Modal -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <h3>Patient History</h3>
                <button onclick="closeModal('historyModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body" style="padding:0;">
                <table style="font-size:0.95rem;"><thead><tr><th>Date</th><th>Service</th><th>Amount</th></tr></thead><tbody id="historyListBody"></tbody></table>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('historyModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- 6. PROFILE & ORG CHART MODAL -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>My Profile & Organization</h3>
                <button onclick="closeModal('profileModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body" style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div class="avatar" style="width: 80px; height: 80px; font-size: 1.5rem; margin: 0 auto 10px;" id="profile-avatar">DA</div>
                        <h4 id="profile-name">Dr. Amalina</h4>
                        <p style="color: var(--text-muted);" id="profile-role">Admin</p>
                    </div>
                    <div style="background: #f8fafc; padding: 15px; border-radius: 12px;">
                        <p style="font-size: 0.9rem; margin-bottom: 5px;"><strong>Username:</strong> <span id="profile-u">amalina</span></p>
                        <p style="font-size: 0.9rem;"><strong>Employee ID:</strong> #EMP001</p>
                    </div>
                </div>
                <div style="flex: 1;">
                    <h5 style="margin-bottom: 15px; color: var(--primary);">Organization Chart</h5>
                    <ul class="org-tree">
                        <li>
                            <div class="org-item"><i class="fa-solid fa-hospital"></i> Klinik Pergigian Azam</div>
                            <ul class="org-tree">
                                <li>
                                    <div class="org-item"><i class="fa-solid fa-user-shield"></i> Dr. Amalina (Admin)</div>
                                    <ul class="org-tree">
                                        <li><div class="org-item"><i class="fa-solid fa-user-doctor"></i> Dr (Test) (Dentist)</div></li>
                                        <li><div class="org-item"><i class="fa-solid fa-user-nurse"></i> User_Test Staff (Nurse)</div></li>
                                        <li><div class="org-item"><i class="fa-solid fa-user-astronaut"></i> Clinic Assistant</div></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('profileModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- 7. INVOICE MODAL -->
    <div class="modal-overlay" id="invoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-file-invoice-dollar"></i> Invoice</h3>
                <button onclick="closeModal('invoiceModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div style="background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #e2e8f0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span style="color:var(--text-muted); font-size:0.8rem;">Patient</span><span style="font-weight:700;" id="bill-p-name">-</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span style="color:var(--text-muted); font-size:0.8rem;">Date</span><span style="font-weight:600;" id="bill-date">-</span></div>
                    <div style="display:flex; justify-content:space-between;"><span style="color:var(--text-muted); font-size:0.8rem;">Phone</span><span style="font-weight:600;" id="bill-phone">-</span></div>
                </div>
                <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-size:0.85rem; font-weight:700;">Services</label>
                    <button class="btn-sm" onclick="addInvoiceItem()" style="font-size:0.8rem; padding:6px 12px;">+ Add Service</button>
                </div>
                <table class="invoice-table" style="width:100%; margin-top:15px;">
                    <thead><tr><th style="width:40%">Item</th><th style="width:20%; text-align:right">Qty</th><th style="width:20%; text-align:right">Price</th><th style="width:20%; text-align:right">Total</th><th></th></tr></thead>
                    <tbody id="bill-items-body"></tbody>
                </table>
                <div style="text-align:right; padding-top:25px; border-top:2px solid #e2e8f0;">
                    <span style="color:var(--text-muted); font-size:0.9rem;">Grand Total</span>
                    <div style="font-size:1.8rem; font-weight:800; color:var(--primary); margin-top:5px;">RM <span id="bill-grand-total">0.00</span></div>
                </div>
            </div>
            <div class="modal-footer no-print">
                <button class="btn-sm" onclick="closeModal('invoiceModal')">Cancel</button>
                <button class="btn-sm btn-bill" onclick="saveAndPrintInvoice()">Save & Print</button>
            </div>
        </div>
    </div>

    <!-- 8. Print Template -->
    <div id="printable-invoice">
        <div style="border-bottom: 3px solid #0284c7; padding-bottom: 30px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display:flex; align-items:center; gap:20px;">
                <img src="https://raw.githubusercontent.com/ddnetwork-ent/clinic-azam-dental/main/IMG_2260.JPG" class="print-logo">
                <div>
                    <h1 style="color: #0284c7; font-size: 2.5rem; margin-bottom: 5px;">Klinik Pergigian Azam</h1>
                    <p style="color: #64748b; margin: 0;">21, Jalan PKS (A), Pusat Komersial Saujana</p>
                    <p style="color: #64748b; margin: 0;">08000 Sungai Petani, Kedah</p>
                    <p style="color: #64748b; margin: 0;">Tel: 017-480 2238</p>
                </div>
            </div>
            <div style="text-align: right;">
                <h3 style="color: #0f172a; margin-bottom: 5px;">RECEIPT</h3>
                <p id="print-invoice-no" style="font-size:1.1rem; font-weight:bold;">Invoice #: INV-001</p>
                <p id="print-date" style="font-size:1rem; color:#64748b;">Date: 21/05/2025</p>
            </div>
        </div>
        <div style="margin-bottom: 40px;">
            <h3 style="color: #0f172a; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 15px; font-size:1.2rem;">Bill To:</h3>
            <p style="font-size:1.1rem;"><strong>Name:</strong> <span id="print-name">-</span></p>
            <p style="font-size:1.1rem;"><strong>Phone:</strong> <span id="print-phone">-</span></p>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 40px; border: 1px solid #e2e8f0;">
            <thead><tr style="background: #f1f5f9;"><th style="border: 1px solid #cbd5e1; padding: 15px; text-align: left;">Description</th><th style="border: 1px solid #cbd5e1; padding: 15px; text-align: center;">Qty</th><th style="border: 1px solid #cbd5e1; padding: 15px; text-align: right;">Price (RM)</th><th style="border: 1px solid #cbd5e1; padding: 15px; text-align: right;">Total (RM)</th></tr></thead>
            <tbody id="print-items-body"></tbody>
        </table>
        <div style="display: flex; justify-content: space-between; align-items:flex-end;">
            <div><p style="font-size: 1rem; color: #64748b;">Thank you!</p><p style="font-size: 1rem; color: #64748b;">Powered by Klinik Azam System</p></div>
            <div style="text-align: right;">
                <h2 style="color: #0f172a;">TOTAL: RM <span id="print-total">0.00</span></h2>
                <div style="margin-top: 50px; border-top: 2px dashed #cbd5e1; padding-top: 15px; width: 200px; margin-left: auto;">Authorized Signature</div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast">
        <i class="fa-solid fa-circle-check" style="color:#4ade80;"></i> 
        <span id="toastMsg">Action Successful</span>
    </div>

    <script>
        // --- DATA & STATE ---
        const users = [{ u: 'amalina', p: '1234', name: 'Dr. Amalina', role: 'Admin', initials: 'DA' }, { u: 'staff', p: 'staff', name: 'User_Test Staff', role: 'Nurse', initials: 'SS' }];
        let currentUser = null;
        let deleteTarget = null;

        const todayStr = new Date().toISOString().split('T')[0]; // Real today

        let appointments = [
            { id: 1, name: "Ali bin Ahmad", phone: "012-3456789", date: todayStr, time: "09:00 AM", items: [{id: 1, qty: 1, price: 35}], status: "Completed" }, 
            { id: 2, name: "Siti Aminah", phone: "019-8765432", date: todayStr, time: "10:30 AM", items: [{id: 2, qty: 1, price: 80}], status: "Pending" },
            { id: 3, name: "Muthu Kumar", phone: "014-5556677", date: todayStr, time: "02:00 PM", items: [{id: 1, qty: 1, price: 35}], status: "Pending" },
            { id: 4, name: "Jessica Wong", phone: "016-2233445", date: "2025-05-20", time: "11:00 AM", items: [{id: 1, qty: 1, price: 35}, {id: 4, qty: 1, price: 120}], status: "Completed" },
            { id: 5, name: "Chong Wei", phone: "011-1122334", date: todayStr, time: "04:00 PM", items: [{id: 1, qty: 1, price: 35}], status: "Cancelled" }
        ];

        let services = [
            { id: 1, name: "General Consultation", price: 35 },
            { id: 2, name: "Scaling & Polishing", price: 80 },
            { id: 3, name: "Root Canal", price: 450 },
            { id: 4, name: "Tooth Extraction", price: 120 },
            { id: 5, name: "Teeth Whitening", price: 600 },
            { id: 6, name: "Dentures", price: 800 },
            { id: 7, name: "Filling (Composite)", price: 150 }
        ];

        let staff = [
            { id: 1, name: "Dr. Amalina", role: "Admin", u: "amalina" },
            { id: 2, name: "User_Test Staff", role: "Nurse", u: "staff" },
            { id: 3, name: "Dr. Ahmad", role: "Dentist", u: "dahmad" }
        ];

        let invoiceItems = [];
        let currentBillAppt = null;

        // FIXED TIME SLOTS
        const defaultSlots = [
            "09:00 AM", "09:30 AM", "10:00 AM", "10:30 AM", "11:00 AM", "11:30 AM", "12:00 PM",
            "02:00 PM", "02:30 PM", "03:00 PM", "03:30 PM", "04:00 PM", "04:30 PM", "05:00 PM", "05:30 PM"
        ];

        let blockedSlots = {}; 
        let closedDates = [];

        // --- AUTH & NAV ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const valid = users.find(user => user.u === u && user.p === p);
            if (valid) {
                currentUser = valid;
                document.getElementById('userNameDisplay').innerText = valid.name;
                document.getElementById('userRoleDisplay').innerText = valid.role;
                document.getElementById('userAvatar').innerText = valid.initials;
                
                document.getElementById('profile-name').innerText = valid.name;
                document.getElementById('profile-role').innerText = valid.role;
                document.getElementById('profile-u').innerText = valid.u;

                document.getElementById('login-screen').classList.add('hidden');
                setTimeout(() => document.getElementById('login-screen').style.display = 'none', 500);
                
                startLiveClock();
                initDateLimits();
                navigateTo('dashboard');
            } else {
                document.getElementById('loginError').innerText = "Invalid credentials";
            }
        }

        function logout() { location.reload(); }

        // --- LIVE CLOCK & DATE ---
        function startLiveClock() {
            setInterval(() => {
                const now = new Date();
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                const s = String(now.getSeconds()).padStart(2, '0');
                document.getElementById('liveClock').innerText = `${h}:${m}:${s}`;
                
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('currentFullDate').innerText = now.toLocaleDateString('en-US', options);
            }, 1000);
        }

        function navigateTo(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[onclick="navigateTo('${viewId}')"]`).classList.add('active');
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            
            const titles = { 'dashboard':'Dashboard', 'appointments':'Appointments', 'booking':'New Booking', 'reports':'Sales Reports', 'staff':'Staff Mgmt', 'patients':'Patients', 'services':'Services', 'slots':'Slot Management' };
            document.getElementById('pageTitle').innerText = titles[viewId];

            if(viewId === 'dashboard') renderDashboard();
            if(viewId === 'appointments') renderAppointments();
            if(viewId === 'reports') {
                document.getElementById('report-date-picker').value = todayStr;
                updateReports();
            }
            if(viewId === 'staff') renderStaff();
            if(viewId === 'patients') renderPatients();
            if(viewId === 'services') renderServices();
            if(viewId === 'slots') {
                document.getElementById('slotDate').value = todayStr;
                renderSlots();
            }
            if(viewId === 'booking') {
                document.getElementById('bk-date').value = todayStr;
                updateBookingTimeOptions();
            }
        }

        function formatDateDisplay(dateStr) {
            if(!dateStr) return '-';
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); 
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function showModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        // --- WHATSAPP REMINDER HELPER ---
        function sendWhatsapp(name, date, time, phone) {
            let cleanPhone = phone.replace(/[^0-9]/g, '');
            if(cleanPhone.startsWith('0')) cleanPhone = '60' + cleanPhone.substring(1);
            
            const displayDate = formatDateDisplay(date);
            
            const message = `Assalamualaikum dan Salam Sejahtera 

Kami dari Azam Dental SP Saujana ingin mengingatkan ${name} mengenai temujanji bersama doktor pada:

 Tarikh & Masa: ${displayDate} ${time}

Mohon hadir 510 minit lebih awal bagi memastikan kelancaran jadual rawatan dan mengelakkan gangguan kepada pesakit seterusnya.

Sekiranya terdapat sebarang perubahan atau pembatalan temujanji, sila maklumkan kepada pihak kami sekurang-kurangnya 30 minit sebelum waktu temujanji.

Mohon sahkan kehadiran temujanji ini dengan membalas mesej ini.

Terima kasih atas kerjasama anda.
> Azam Dental SP Saujana`;

            const encodedMsg = encodeURIComponent(message);
            const url = `https://wa.me/${cleanPhone}?text=${encodedMsg}`;
            window.open(url, '_blank');
        }

        // --- CORE SLOT LOGIC ---
        function getAvailableSlots(dateStr) {
            if(!dateStr) return [];
            
            const bookedTimes = appointments
                .filter(a => a.date === dateStr && a.status !== 'Cancelled' && a.status !== 'Completed')
                .map(a => a.time);

            const blocked = blockedSlots[dateStr] || [];

            return defaultSlots.filter(time => {
                const isBooked = bookedTimes.includes(time);
                const isBlocked = blocked.includes(time);
                return !isBooked && !isBlocked;
            });
        }

        function updateBookingTimeOptions() {
            const dateVal = document.getElementById('bk-date').value;
            const timeSelect = document.getElementById('bk-time');
            
            if(!dateVal || dateVal < todayStr) {
                timeSelect.innerHTML = '<option value="">Select Valid Date</option>';
                timeSelect.disabled = true;
                return;
            }

            timeSelect.disabled = false;
            timeSelect.innerHTML = '<option value="">Select Time</option>';

            const availableTimes = getAvailableSlots(dateVal);

            if(availableTimes.length === 0) {
                const opt = document.createElement('option');
                opt.text = "No slots available";
                opt.disabled = true;
                timeSelect.add(opt);
                timeSelect.disabled = true; 
            } else {
                availableTimes.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.text = t;
                    timeSelect.add(opt);
                });
            }
        }

        function updateEditTimeOptions() {
            const dateVal = document.getElementById('edit-appt-date').value;
            const timeSelect = document.getElementById('edit-appt-time');
            const currentApptId = parseInt(document.getElementById('edit-appt-id').value);
            
            timeSelect.innerHTML = '';
            
            if(!dateVal) return;

            const currentAppt = appointments.find(a => a.id === currentApptId);
            const availableTimes = getAvailableSlots(dateVal);
            
            let timesToShow = [...availableTimes];
            if(currentAppt && currentAppt.date === dateVal && !timesToShow.includes(currentAppt.time)) {
                timesToShow.push(currentAppt.time);
                timesToShow.sort(); 
            }

            timesToShow.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.text = t;
                if(currentAppt && currentAppt.time === t) opt.selected = true;
                timeSelect.add(opt);
            });
        }

        // --- SALES LOGIC ---
        function calculateTotalForDate(dateStr) {
            let total = 0;
            const dayAppts = appointments.filter(a => a.date === dateStr && a.status === 'Completed');
            
            dayAppts.forEach(a => {
                if(a.items) {
                    a.items.forEach(i => {
                        total += (i.price * i.qty);
                    });
                }
            });
            return total;
        }

        // --- INITIALIZATION ---
        function initDateLimits() {
            document.getElementById('bk-date').min = todayStr;
            populateServiceDropdowns();
        }

        function populateServiceDropdowns() {
            const sSelects = ['bk-service', 'de-service', 'edit-appt-service'];
            sSelects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.innerHTML = '';
                    services.forEach(s => el.innerHTML += `<option value="${s.id}">${s.name} (RM ${s.price})</option>`);
                }
            });
        }

        // --- BOOKING ---
        function saveNewBooking(e) {
            e.preventDefault();
            const dateVal = document.getElementById('bk-date').value;
            const timeVal = document.getElementById('bk-time').value;
            
            if(dateVal < todayStr) {
                alert("Cannot book appointments in past.");
                return;
            }

            const available = getAvailableSlots(dateVal);
            if(!available.includes(timeVal)) {
                alert("This slot was just booked by someone else. Please choose another time.");
                updateBookingTimeOptions();
                return;
            }

            const sId = parseInt(document.getElementById('bk-service').value);
            const sPrice = services.find(s=>s.id === sId).price;
            
            appointments.push({
                id: Date.now(),
                name: document.getElementById('bk-name').value,
                phone: document.getElementById('bk-phone').value,
                date: dateVal,
                time: timeVal,
                items: [{ id: sId, qty: 1, price: sPrice }],
                status: 'Confirmed'
            });
            
            e.target.reset();
            document.getElementById('bk-date').value = todayStr;
            updateBookingTimeOptions();
            showToast("Booking Confirmed");
            renderAppointments();
            renderDashboard();
            navigateTo('appointments');
        }

        // --- DATA ENTRY ---
        function saveHistoricalData(e) {
            e.preventDefault();
            const sId = parseInt(document.getElementById('de-service').value);
            const sPrice = services.find(s=>s.id === sId).price;
            
            let tVal = document.getElementById('de-time').value;
            let [h, m] = tVal.split(':');
            let suffix = h >= 12 ? "PM" : "AM";
            let h12 = h % 12 || 12;
            let timeStr = `${h12}:${m} ${suffix}`;

            appointments.push({
                id: Date.now(),
                name: document.getElementById('de-name').value,
                phone: document.getElementById('de-phone').value,
                date: document.getElementById('de-date').value,
                time: timeStr,
                items: [{ id: sId, qty: 1, price: sPrice }],
                status: 'Completed'
            });
            e.target.reset();
            showToast("Historical Data Added");
            renderAppointments();
            renderPatients();
        }

        // --- RENDER ---
        function renderDashboard() {
            const todaysAppts = appointments.filter(a => a.date === todayStr && a.status !== 'Cancelled');
            document.getElementById('d-stat-today').innerText = todaysAppts.length;
            document.getElementById('d-stat-history').innerText = appointments.filter(a => a.status === 'Completed').length;
            
            const todaySales = calculateTotalForDate(todayStr);
            document.getElementById('d-stat-sales').innerText = 'RM ' + todaySales.toLocaleString();

            const tbody = document.querySelector('#dashboard-table tbody');
            tbody.innerHTML = '';
            todaysAppts.forEach(a => {
                const sName = a.items.length > 0 ? a.items.map(i => services.find(s=>s.id===i.id).name).join(', ') : "Unknown";
                tbody.innerHTML += `
                <tr>
                    <td style="font-weight:700;">${a.time}</td>
                    <td>${a.name}</td>
                    <td>${sName}</td>
                    <td><span class="badge badge-${a.status.toLowerCase()}">${a.status}</span></td>
                    <td>
                        ${a.status !== 'Completed' ? `<a href="#" class="btn-sm btn-wa" onclick="sendWhatsapp('${a.name}', '${a.date}', '${a.time}', '${a.phone}')" title="WhatsApp Reminder"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
                        <button class="btn-sm" onclick="openEditAppt(${a.id})"><i class="fa-solid fa-pen"></i></button> 
                        <button class="btn-sm btn-bill" onclick="openInvoice(${a.id})"><i class="fa-solid fa-file-invoice"></i> Bill</button> 
                        <button class="btn-sm btn-delete" onclick="requestDelete('appointment', ${a.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        function renderAppointments() {
            const schedule = appointments.filter(a => a.status !== 'Cancelled' && a.status !== 'Completed').sort((a,b) => new Date(a.date) - new Date(b.date));
            const tBody = document.querySelector('#today-table tbody');
            tBody.innerHTML = '';
            schedule.forEach(a => {
                const sName = a.items.length > 0 ? a.items.map(i => services.find(s=>s.id===i.id).name).join(', ') : "Unknown";
                tBody.innerHTML += `
                <tr>
                    <td>${formatDateDisplay(a.date)}</td>
                    <td style="font-weight:700; color:var(--primary);">${a.time}</td>
                    <td>${a.name}</td>
                    <td>${a.phone}</td>
                    <td>${sName}</td>
                    <td><span class="badge badge-${a.status.toLowerCase()}">${a.status}</span></td>
                    <td>
                        <a href="#" class="btn-sm btn-wa" onclick="sendWhatsapp('${a.name}', '${a.date}', '${a.time}', '${a.phone}')" title="Send Reminder"><i class="fa-brands fa-whatsapp"></i> Remind</a>
                        <button class="btn-sm" onclick="openEditAppt(${a.id})"><i class="fa-solid fa-pen"></i></button> 
                        <button class="btn-sm btn-bill" onclick="openInvoice(${a.id})"><i class="fa-solid fa-file-invoice"></i> Bill</button> 
                        <button class="btn-sm btn-delete" onclick="requestDelete('appointment', ${a.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });

            const history = appointments.filter(a => a.status === 'Completed').sort((a,b) => new Date(b.date) - new Date(a.date));
            const hBody = document.querySelector('#history-table tbody');
            hBody.innerHTML = '';
            history.forEach(a => {
                const sName = a.items.length > 0 ? a.items.map(i => services.find(s=>s.id===i.id).name).join(', ') : "Unknown";
                hBody.innerHTML += `<tr><td>${formatDateDisplay(a.date)}</td><td style="font-weight:600;">${a.time}</td><td>${a.name}</td><td>${sName}</td><td><button class="btn-sm" onclick="openInvoice(${a.id})"><i class="fa-solid fa-eye"></i> View</button></td></tr>`;
            });

            const cancelled = appointments.filter(a => a.status === 'Cancelled').sort((a,b) => new Date(b.date) - new Date(a.date));
            const cBody = document.querySelector('#cancelled-table tbody');
            cBody.innerHTML = '';
            cancelled.forEach(a => {
                const sName = a.items.length > 0 ? a.items.map(i => services.find(s=>s.id===i.id).name).join(', ') : "Unknown";
                cBody.innerHTML += `<tr><td>${formatDateDisplay(a.date)}</td><td style="font-weight:600; color:var(--danger);">${a.time}</td><td>${a.name}</td><td>${sName}</td><td><button class="btn-sm btn-delete" onclick="requestDelete('appointment', ${a.id})"><i class="fa-solid fa-trash"></i> Delete Record</button></td></tr>`;
            });
        }

        // --- UPDATED REPORTS WITH LOADING ---
        function updateReports() {
            const dateVal = document.getElementById('report-date-picker').value;
            const tbody = document.querySelector('#report-table tbody');
            const summaryLabel = document.getElementById('report-date-label');
            const totalDisplay = document.getElementById('report-total-amount');

            // Clear and Show Spinner
            tbody.innerHTML = `
                <tr>
                    <td colspan="4">
                        <div class="spinner-container">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading Transactions...</div>
                        </div>
                    </td>
                </tr>`;
            summaryLabel.innerText = "...";
            totalDisplay.innerText = "0.00";

            // Simulate Network/Processing Delay (500ms)
            setTimeout(() => {
                // Actual Logic
                summaryLabel.innerText = formatDateDisplay(dateVal);
                const total = calculateTotalForDate(dateVal);
                totalDisplay.innerText = total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

                const dayAppts = appointments.filter(a => a.date === dateVal && a.status === 'Completed').sort((a,b) => new Date(a.time) - new Date(b.time));
                tbody.innerHTML = '';
                
                if(dayAppts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No completed transactions for this date.</td></tr>';
                } else {
                    dayAppts.forEach(a => {
                        let itemsStr = a.items.map(i => {
                            const s = services.find(sv => sv.id === i.id);
                            return `${s.name} (x${i.qty})`;
                        }).join(', ');
                        let apptTotal = a.items.reduce((sum, i) => sum + (i.price * i.qty), 0);

                        tbody.innerHTML += `
                        <tr>
                            <td style="font-weight:600;">${a.time}</td>
                            <td>${a.name}</td>
                            <td><small>${itemsStr}</small></td>
                            <td style="font-weight:700; color:var(--success);">RM ${apptTotal}</td>
                        </tr>`;
                    });
                }
            }, 500);
        }

        function toggleCancelledTable() {
            const btn = document.getElementById('toggleCancelledBtn');
            const container = document.getElementById('cancelled-container');
            
            if(container.style.display === 'block') {
                container.style.display = 'none';
                btn.classList.remove('btn-bill');
                btn.innerText = "Show Cancelled";
            } else {
                container.style.display = 'block';
                btn.classList.add('btn-bill');
                btn.innerText = "Hide Cancelled";
            }
        }

        function renderPatients() {
            const patientMap = {};
            appointments.forEach(a => {
                if(a.status === 'Completed') {
                    if(!patientMap[a.name]) patientMap[a.name] = { count: 0, phone: a.phone };
                    patientMap[a.name].count++;
                }
                if(!patientMap[a.name]) patientMap[a.name] = { count: 0, phone: a.phone };
            });
            const tbody = document.querySelector('#patients-table tbody');
            tbody.innerHTML = '';
            Object.keys(patientMap).forEach(name => {
                const p = patientMap[name];
                tbody.innerHTML += `<tr><td style="font-weight:600;">${name}</td><td>${p.phone}</td><td>${p.count}</td><td><button class="btn-sm" onclick="openHistory('${name}')"><i class="fa-solid fa-clock-rotate-left"></i> View</button> <button class="btn-sm btn-delete" onclick="requestDelete('patient', '${name}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        function renderServices() {
            const tbody = document.querySelector('#services-table tbody');
            tbody.innerHTML = '';
            services.forEach(s => {
                tbody.innerHTML += `<tr><td>${s.name}</td><td style="font-weight:700;">RM ${s.price}</td><td><button class="btn-sm" onclick="openEditService(${s.id})"><i class="fa-solid fa-pen"></i> Edit</button> <button class="btn-sm btn-delete" onclick="requestDelete('service', ${s.id})"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        function renderStaff() {
            const tbody = document.querySelector('#staff-table tbody');
            tbody.innerHTML = '';
            staff.forEach(s => {
                tbody.innerHTML += `<tr><td style="font-weight:600;">${s.name}</td><td><span class="badge badge-info">${s.role}</span></td><td>${s.u}</td><td><button class="btn-sm" onclick="openEditStaff(${s.id})"><i class="fa-solid fa-pen"></i> Edit</button> <button class="btn-sm btn-delete" onclick="requestDelete('staff', ${s.id})"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        // --- UPDATED SLOTS WITH LOADING ---
        function renderSlots() {
            const dateVal = document.getElementById('slotDate').value;
            const grid = document.getElementById('slotGrid');
            const btn = document.getElementById('clinicStatusBtn');
            
            // Clear and Show Spinner
            grid.innerHTML = `
                <div style="grid-column: 1/-1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px;">
                    <div class="spinner"></div>
                    <div class="loading-text">Checking Availability...</div>
                </div>
            `;

            // Simulate Network/Processing Delay (500ms)
            setTimeout(() => {
                const isClosed = closedDates.includes(dateVal);
                if(isClosed) {
                    grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:30px; color:var(--text-muted); background:#fff; border-radius:12px; font-weight:600;">Clinic Closed</div>';
                    btn.innerHTML = '<i class="fa-solid fa-toggle-off"></i> Open Clinic';
                    return;
                } else {
                    btn.innerHTML = '<i class="fa-solid fa-toggle-on"></i> Set as Closed';
                }
                grid.innerHTML = '';
                
                const blocked = blockedSlots[dateVal] || [];
                const bookedAppts = appointments.filter(a => a.date === dateVal && a.status !== 'Cancelled' && a.status !== 'Completed');
                
                defaultSlots.forEach(time => {
                    const isBlocked = blocked.includes(time);
                    const booking = bookedAppts.find(a => a.time === time);
                    
                    const btnDiv = document.createElement('div');
                    let className = 'slot-btn';
                    let clickHandler = null;

                    if (booking) {
                        className += ' booked';
                        btnDiv.innerHTML = `${time}<br><small>${booking.name}</small>`;
                    } else if (isBlocked) {
                        className += ' blocked';
                        btnDiv.innerHTML = `${time}<br><small>Break</small>`;
                        clickHandler = () => toggleSlot(dateVal, time, btnDiv);
                    } else {
                        btnDiv.innerHTML = time;
                        clickHandler = () => toggleSlot(dateVal, time, btnDiv);
                    }
                    
                    btnDiv.className = className;
                    if(clickHandler) btnDiv.onclick = clickHandler;
                    grid.appendChild(btnDiv);
                });
            }, 500);
        }

        function toggleSlot(date, time, el) {
            if(!blockedSlots[date]) blockedSlots[date] = [];
            const idx = blockedSlots[date].indexOf(time);
            
            const booking = appointments.find(a => a.date === date && a.time === time && a.status !== 'Cancelled');
            if(booking) {
                alert("Cannot toggle break: This slot is booked by a patient.");
                return;
            }

            if(idx === -1) {
                blockedSlots[date].push(time);
                el.classList.add('blocked'); el.classList.remove('booked');
                el.innerHTML = time + '<br><small>Break</small>';
                el.onclick = () => toggleSlot(date, time, el);
            } else {
                blockedSlots[date].splice(idx, 1);
                el.classList.remove('blocked'); 
                el.innerHTML = time;
                el.onclick = () => toggleSlot(date, time, el);
            }
        }

        function toggleClinicStatus() {
            const date = document.getElementById('slotDate').value;
            const idx = closedDates.indexOf(date);
            if(idx === -1) { closedDates.push(date); showToast("Clinic Closed"); } 
            else { closedDates.splice(idx, 1); showToast("Clinic Open"); }
            renderSlots();
        }

        // --- EDIT FUNCTIONS ---
        function openEditAppt(id) {
            const a = appointments.find(x => x.id === id);
            document.getElementById('edit-appt-id').value = id;
            document.getElementById('edit-appt-date').value = a.date;
            updateEditTimeOptions();
            
            const srvSelect = document.getElementById('edit-appt-service');
            srvSelect.innerHTML = '';
            services.forEach(s => srvSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            if(a.items && a.items[0]) srvSelect.value = a.items[0].id;
            
            showModal('editApptModal');
        }

        function saveApptEdit() {
            const id = parseInt(document.getElementById('edit-appt-id').value);
            const dateVal = document.getElementById('edit-appt-date').value;
            const timeVal = document.getElementById('edit-appt-time').value;
            
            const conflict = appointments.find(a => a.date === dateVal && a.time === timeVal && a.status !== 'Cancelled' && a.status !== 'Completed' && a.id !== id);
            if(conflict) {
                alert("Time slot conflict.");
                return;
            }

            if(dateVal < todayStr) {
                alert("Cannot move to past date.");
                return;
            }

            const idx = appointments.findIndex(a => a.id === id);
            if(idx > -1) {
                appointments[idx].date = dateVal;
                appointments[idx].time = timeVal;
                const sId = parseInt(document.getElementById('edit-appt-service').value);
                const sPrice = services.find(s=>s.id === sId).price;
                appointments[idx].items = [{id: sId, qty: 1, price: sPrice}];
                renderAppointments();
                renderDashboard();
                closeModal('editApptModal');
                showToast("Updated");
            }
        }

        function openEditService(id) {
            const s = services.find(x => x.id === id);
            document.getElementById('edit-service-id').value = id;
            document.getElementById('edit-service-name').value = s.name;
            document.getElementById('edit-service-price').value = s.price;
            showModal('editServiceModal');
        }

        function saveServiceEdit() {
            const id = parseInt(document.getElementById('edit-service-id').value);
            const idx = services.findIndex(s => s.id === id);
            if(idx > -1) {
                services[idx].name = document.getElementById('edit-service-name').value;
                services[idx].price = parseFloat(document.getElementById('edit-service-price').value);
                renderServices();
                closeModal('editServiceModal');
                showToast("Service Updated");
            }
        }

        function openEditStaff(id) {
            const s = staff.find(x => x.id === id);
            document.getElementById('edit-staff-id').value = id;
            document.getElementById('edit-staff-name').value = s.name;
            document.getElementById('edit-staff-role').value = s.role;
            document.getElementById('edit-staff-u').value = s.u;
            showModal('editStaffModal');
        }

        function saveStaffEdit() {
            const id = parseInt(document.getElementById('edit-staff-id').value);
            if(id) {
                const idx = staff.findIndex(s => s.id === id);
                staff[idx].name = document.getElementById('edit-staff-name').value;
                staff[idx].role = document.getElementById('edit-staff-role').value;
                staff[idx].u = document.getElementById('edit-staff-u').value;
            } else {
                staff.push({
                    id: Date.now(),
                    name: document.getElementById('edit-staff-name').value,
                    role: document.getElementById('edit-staff-role').value,
                    u: document.getElementById('edit-staff-u').value,
                    initials: document.getElementById('edit-staff-name').value.substring(0,2).toUpperCase()
                });
                users.push({
                    u: document.getElementById('edit-staff-u').value,
                    p: '1234',
                    name: document.getElementById('edit-staff-name').value,
                    role: document.getElementById('edit-staff-role').value,
                    initials: document.getElementById('edit-staff-name').value.substring(0,2).toUpperCase()
                });
            }
            renderStaff();
            closeModal('editStaffModal');
            showToast("Staff Updated");
        }

        function openHistory(name) {
            const history = appointments.filter(a => a.name === name && a.status === 'Completed').sort((a,b) => new Date(b.date) - new Date(a.date));
            const tbody = document.getElementById('historyListBody');
            tbody.innerHTML = '';
            if(history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No history found.</td></tr>';
            } else {
                history.forEach(a => {
                    const s = services.find(x => x.id === a.items[0].id);
                    tbody.innerHTML += `<tr><td>${a.date}</td><td>${s ? s.name : 'Unknown'}</td><td>RM ${s ? s.price : '0'}</td></tr>`;
                });
            }
            showModal('historyModal');
        }

        function openProfile() {
            showModal('profileModal');
        }

        // --- INVOICE LOGIC ---
        function openInvoice(id) {
            const a = appointments.find(x => x.id === id);
            currentBillAppt = a;
            document.getElementById('bill-p-name').innerText = a.name;
            document.getElementById('bill-date').innerText = formatDateDisplay(a.date);
            document.getElementById('bill-phone').innerText = a.phone;
            
            if(a.items && a.items.length > 0) {
                invoiceItems = JSON.parse(JSON.stringify(a.items));
            } else {
                invoiceItems = [{ id: 1, qty: 1, price: 35 }];
            }
            renderInvoiceRows();
            showModal('invoiceModal');
        }

        function addInvoiceItem() { invoiceItems.push({ id: 1, qty: 1, price: 35 }); renderInvoiceRows(); }
        function removeInvoiceItem(idx) { invoiceItems.splice(idx, 1); renderInvoiceRows(); }
        function updateInvoiceItem(idx, field, value) {
            if(field === 'id') {
                const s = services.find(x => x.id == value);
                invoiceItems[idx].price = s.price;
                invoiceItems[idx].id = s.id;
            } else {
                invoiceItems[idx][field] = value;
            }
            renderInvoiceRows();
        }

        function renderInvoiceRows() {
            const tbody = document.getElementById('bill-items-body');
            tbody.innerHTML = '';
            let total = 0;
            invoiceItems.forEach((item, idx) => {
                const lineTotal = item.price * item.qty;
                total += lineTotal;
                let options = '';
                services.forEach(s => options += `<option value="${s.id}" ${s.id == item.id ? 'selected' : ''}>${s.name}</option>`);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <tr>
                    <td><select class="form-input" style="padding:8px;" onchange="updateInvoiceItem(${idx}, 'id', this.value)">${options}</select></td>
                    <td><input type="number" value="${item.qty}" min="1" style="width:100%; text-align:center; border:1px solid #e2e8f0; border-radius:4px;" onchange="updateInvoiceItem(${idx}, 'qty', this.value)"></td>
                    <td style="text-align:right;">RM ${item.price}</td>
                    <td style="text-align:right; font-weight:700;">RM ${lineTotal}</td>
                    <td><button onclick="removeInvoiceItem(${idx})" style="color:var(--danger); background:none;"><i class="fa-solid fa-times"></i></button></td>
                </tr>`;
                tbody.appendChild(tr);
            });
            document.getElementById('bill-grand-total').innerText = total.toFixed(2);
        }

        function saveAndPrintInvoice() {
            currentBillAppt.items = invoiceItems;
            currentBillAppt.status = 'Completed';

            document.getElementById('print-name').innerText = currentBillAppt.name;
            document.getElementById('print-phone').innerText = currentBillAppt.phone;
            document.getElementById('print-date').innerText = "Date: " + formatDateDisplay(currentBillAppt.date);
            document.getElementById('print-invoice-no').innerText = "Invoice #: INV-" + currentBillAppt.id;

            const printBody = document.getElementById('print-items-body');
            printBody.innerHTML = '';
            let total = 0;
            invoiceItems.forEach(item => {
                const s = services.find(x => x.id == item.id);
                const line = item.price * item.qty;
                total += line;
                printBody.innerHTML += `<tr><td style="border:1px solid #e2e8f0; padding:8px;">${s.name}</td><td style="border:1px solid #e2e8f0; padding:8px; text-align:center;">${item.qty}</td><td style="border:1px solid #e2e8f0; padding:8px; text-align:right;">${item.price.toFixed(2)}</td><td style="border:1px solid #e2e8f0; padding:8px; text-align:right;">${line.toFixed(2)}</td></tr>`;
            });
            document.getElementById('print-total').innerText = total.toFixed(2);

            closeModal('invoiceModal');
            renderAppointments();
            renderDashboard();
            showToast("Saved & Printing...");
            setTimeout(() => window.print(), 500);
        }

        // --- DELETE APPROVAL ---
        function requestDelete(type, id) {
            deleteTarget = { type, id };
            document.getElementById('adminPinInput').value = ''; document.getElementById('pinError').innerText = '';
            showModal('pinModal');
        }

        function confirmDeleteAction() {
            const pin = document.getElementById('adminPinInput').value;
            if (currentUser.u === 'amalina' || pin === '1234') {
                if (deleteTarget.type === 'appointment') appointments = appointments.filter(a => a.id !== deleteTarget.id);
                if (deleteTarget.type === 'service') services = services.filter(s => s.id !== deleteTarget.id);
                if (deleteTarget.type === 'staff') { 
                    staff = staff.filter(s => s.id !== deleteTarget.id); 
                    const sData = staff.find(x => x.id === deleteTarget.id); 
                    users = users.filter(u => u.u !== sData?.u);
                }
                if (deleteTarget.type === 'patient') appointments = appointments.filter(a => a.name !== deleteTarget.id);
                
                closeModal('pinModal');
                navigateTo(document.querySelector('.nav-item.active').getAttribute('onclick').match(/'([^']+)'/)[1]); 
                showToast("Deleted Successfully");
            } else {
                document.getElementById('pinError').innerText = "Wrong PIN";
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('hide');
            t.classList.add('show');
            setTimeout(() => {
                t.classList.remove('show');
                t.classList.add('hide');
            }, 3000);
        }

    </script>
</body>
</html>
